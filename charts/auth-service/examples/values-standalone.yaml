# Standalone Deployment Configuration
# Deploy auth-service independently without the governance-platform umbrella chart
#
# Usage:
#   helm install auth-service ./charts/auth-service -f examples/values-standalone.yaml
#
# When NOT using the umbrella chart, you must provide ALL configuration values
# directly since there are no global values to inherit from.
#
# This example demonstrates:
#   - Complete standalone configuration without umbrella chart
#   - All required values explicitly set
#   - No reliance on global.* values
#   - Self-contained deployment

# =============================================================================
# APPLICATION CONFIGURATION
# =============================================================================

enabled: true

config:
  server:
    port: 8080
    host: "0.0.0.0"
    readTimeout: "30s"
    writeTimeout: "30s"
    idleTimeout: "120s"
    environment: "production"
    swaggerEnabled: false

  logging:
    level: "info"
    format: "json"
    skipPaths: "/health,/health/live,/health/ready,/metrics"

  cors:
    enabled: false
    origins: "*"

  # Identity Provider - REQUIRED
  idp:
    provider: "auth0" # or "keycloak"
    issuer: "https://your-tenant.auth0.com/"
    skipIssuerVerification: false

    auth0:
      domain: "your-tenant.auth0.com"
      enableManagementAPI: true
      managementAudience: "https://your-tenant.auth0.com/api/v2/"
      apiIdentifier: "https://api.your-app.com"
      defaultConnection: "Username-Password-Authentication"
      defaultRoles: ["user"]
      sendInvitationEmail: true
      syncAtStartup: false
      syncPageSize: 100

    # Keycloak config (used if provider: "keycloak")
    keycloak:
      realm: ""
      adminUrl: ""
      enableUserManagement: false
      enableGroupSync: false

  # Key Vault - REQUIRED for DID operations
  keyVault:
    provider: "azure" # or "hashicorp" or "local"
    cacheTTLMinutes: 15

    azure:
      vaultUrl: "https://your-keyvault.vault.azure.net/"
      tenantId: "your-azure-tenant-id"

    hashicorp:
      address: ""

  # Service URLs - REQUIRED (no auto-generation without umbrella)
  integrations:
    governanceServiceUrl: "http://governance-service:10001"

  serviceAccounts:
    autoCreate: true
    governanceWorker:
      enabled: true
      name: "governance-worker"
      description: "Automated governance worker"
      scopes:
        - "governance:declarations:create"
        - "integrity:statements:create"
      audience: "https://your-tenant.auth0.com/api/v2/"

  tokenExchange:
    enabled: false
    keyId: ""

  rbac:
    cache:
      enabled: true
      ttl: "300s"
      maxSize: 1000

  rateLimit:
    enabled: false
    requestsPerMinute: 60

# =============================================================================
# DATABASE CONFIGURATION - REQUIRED
# =============================================================================

externalDatabase:
  # Must be explicitly configured - no global fallback
  host: "your-postgresql-host"
  port: "5432"
  name: "governance"
  user: "postgres"
  password: "" # Use passwordSecretKeyRef instead
  sslMode: "require"
  maxOpenConns: 25
  maxIdleConns: 5
  connMaxLifetime: "5m"

  passwordSecretKeyRef:
    name: "auth-service-database"
    key: "password"

migrations:
  runAtStartup: true
  path: "/internal/database/migrations"

# =============================================================================
# SECRET CONFIGURATION - ALL REQUIRED
# =============================================================================
#
# Without the umbrella chart, you must create these secrets manually:
#
# kubectl create secret generic auth-service-auth \
#   --from-literal=client-id=<your-client-id> \
#   --from-literal=client-secret=<your-client-secret> \
#   --from-literal=mgmt-client-id=<your-mgmt-client-id> \
#   --from-literal=mgmt-client-secret=<your-mgmt-client-secret>
#
# kubectl create secret generic auth-service-security \
#   --from-literal=api-secret=$(openssl rand -base64 32) \
#   --from-literal=jwt-secret=$(openssl rand -base64 32) \
#   --from-literal=session-secret=$(openssl rand -base64 32)
#
# kubectl create secret generic auth-service-database \
#   --from-literal=password=<your-db-password>
#
# kubectl create secret generic auth-service-keyvault \
#   --from-literal=client-id=<azure-client-id> \
#   --from-literal=client-secret=<azure-client-secret> \
#   --from-literal=tenant-id=<azure-tenant-id> \
#   --from-literal=vault-url=<vault-url>
#
# kubectl create secret generic auth-service-governance-worker \
#   --from-literal=encryption-key=$(openssl rand -base64 32) \
#   --from-literal=client-id=<worker-client-id> \
#   --from-literal=client-secret=<worker-client-secret>

secrets:
  # Auth0 credentials
  auth:
    auth0:
      name: "auth-service-auth"
    keycloak:
      name: "" # For token exchange if using Keycloak

  # Auth service credentials
  authService:
    name: "auth-service-security"

  # Secret manager credentials
  secretManager:
    azure_key_vault:
      name: "auth-service-keyvault"

  # Governance worker credentials
  governanceWorker:
    name: "auth-service-governance-worker"

# =============================================================================
# DEPLOYMENT CONFIGURATION
# =============================================================================

replicaCount: 2

image:
  repository: ghcr.io/eqtylab/auth-service
  pullPolicy: IfNotPresent
  tag: ""

imagePullSecrets: []
  # - name: "registry-credentials"

nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: true
  automount: true
  annotations: {}
  name: ""

podAnnotations: {}
podLabels: {}

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1000

resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi

autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

# =============================================================================
# SERVICE CONFIGURATION
# =============================================================================

service:
  enabled: true
  type: ClusterIP
  port: 8080

# =============================================================================
# INGRESS CONFIGURATION
# =============================================================================

ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  hosts:
    - host: auth.your-domain.com
      paths:
        - path: "/authService(/|$)(.*)"
          pathType: ImplementationSpecific
  tls:
    - secretName: auth-service-tls
      hosts:
        - auth.your-domain.com

# =============================================================================
# OBSERVABILITY
# =============================================================================

metrics:
  enabled: true
  port: 9090
  path: /metrics
  serviceMonitor:
    enabled: false
    interval: "30s"
    scrapeTimeout: "10s"
    labels: {}

# =============================================================================
# HIGH AVAILABILITY
# =============================================================================

podDisruptionBudget:
  enabled: true
  minAvailable: 1

nodeSelector: {}
tolerations: []

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - auth-service
          topologyKey: kubernetes.io/hostname

# =============================================================================
# NETWORK POLICY
# =============================================================================

networkPolicy:
  enabled: false
  ingress: []
  egress: []

# =============================================================================
# PROBES
# =============================================================================

startupProbe:
  httpGet:
    path: /health
    port: http
  failureThreshold: 30
  periodSeconds: 10

livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

readinessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3
  successThreshold: 1

# =============================================================================
# VOLUMES
# =============================================================================

volumes: []
volumeMounts: []

# =============================================================================
# MIGRATION JOB
# =============================================================================

migration:
  enabled: false
  backoffLimit: 3
  activeDeadlineSeconds: 300
  ttlSecondsAfterFinished: 300
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

# =============================================================================
# EXTRA CONFIGURATION
# =============================================================================

extraEnvVars: []
extraEnvVarsSecret: ""
extraEnvVarsConfigMap: ""
extraContainers: []
extraInitContainers: []
extraManifests: []
