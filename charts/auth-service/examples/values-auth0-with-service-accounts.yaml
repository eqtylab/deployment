# Auth0 with Service Accounts Configuration
# This values file shows a complete Auth0 setup with governance worker service accounts
#
# Usage:
#   helm install auth-service ./charts/auth-service -f examples/values-auth0-with-service-accounts.yaml
#
# This example demonstrates:
#   - Auth0 as identity provider with Management API enabled
#   - Governance worker service account for automated processing
#   - Azure Key Vault for DID key signing
#   - Full secret configuration using platform-* naming convention

# =============================================================================
# APPLICATION CONFIGURATION
# =============================================================================

config:
  # Server configuration
  server:
    environment: "production"
    swaggerEnabled: false

  # Logging configuration
  logging:
    level: "info"
    format: "json"
    skipPaths: "/health,/health/live,/health/ready,/metrics"

  # CORS disabled - handled by ingress
  cors:
    enabled: false
    origins: "*"

  # Identity Provider configuration
  idp:
    provider: "auth0"
    issuer: "https://your-tenant.auth0.com/"
    skipIssuerVerification: false

    # Auth0-specific configuration
    auth0:
      domain: "your-tenant.auth0.com"
      enableManagementAPI: true
      managementAudience: "https://your-tenant.auth0.com/api/v2/"
      apiIdentifier: "https://api.your-app.com"
      defaultConnection: "Username-Password-Authentication"
      defaultRoles: ["user"]
      sendInvitationEmail: true
      syncAtStartup: true
      syncPageSize: 100

  # Key Vault configuration for DID key signing
  keyVault:
    provider: "azure"
    cacheTTLMinutes: 15
    azure:
      vaultUrl: "https://your-vault.vault.azure.net/"
      tenantId: "your-azure-tenant-id"

  # Service integration URLs
  integrations:
    governanceServiceUrl: "http://governance-platform-governance-service:10001"

  # Service account configuration - ENABLED
  serviceAccounts:
    autoCreate: true
    governanceWorker:
      enabled: true
      name: "governance-worker"
      description: "Automated governance service worker for processing indicator evaluations"
      scopes:
        - "governance:declarations:create"
        - "integrity:statements:create"
      # Auth0 API audience for worker token requests
      audience: "https://your-tenant.auth0.com/api/v2/"

  # RBAC cache configuration
  rbac:
    cache:
      enabled: true
      ttl: "300s"
      maxSize: 1000

# =============================================================================
# DATABASE CONFIGURATION
# =============================================================================

externalDatabase:
  host: "your-database-host.com"
  port: 5432
  name: "governance"
  user: "postgres"
  sslMode: "require"
  maxOpenConns: 25
  maxIdleConns: 5
  connMaxLifetime: "5m"

  passwordSecretKeyRef:
    name: "platform-database"
    key: "password"

migrations:
  runAtStartup: true
  path: "/internal/database/migrations"

# =============================================================================
# SECRET CONFIGURATION
# =============================================================================
#
# Required secrets (create these before deployment):
#
# 1. platform-database
#    - password: Database password
#
# 2. platform-auth0
#    - client-id: Auth0 application client ID
#    - client-secret: Auth0 application client secret
#
# 3. platform-auth-service
#    - api-secret: API secret for service authentication
#    - jwt-secret: JWT signing secret
#
# 4. platform-azure-key-vault
#    - client-id: Azure service principal client ID
#    - client-secret: Azure service principal client secret
#
# 5. platform-governance-worker
#    - encryption-key: Encryption key for service account credentials (openssl rand -base64 32)
#    - client-id: Auth0 M2M application client ID for worker
#    - client-secret: Auth0 M2M application client secret for worker

secrets:
  # Auth0 credentials
  auth:
    auth0:
      name: "platform-auth0"

  # Auth service credentials
  authService:
    name: "platform-auth-service"

  # Secret manager credentials
  secretManager:
    azure_key_vault:
      name: "platform-azure-key-vault"

  # Governance worker credentials
  governanceWorker:
    name: "platform-governance-worker"

# =============================================================================
# DEPLOYMENT CONFIGURATION
# =============================================================================

replicaCount: 2

image:
  repository: ghcr.io/eqtylab/auth-service
  pullPolicy: Always
  tag: "" # Uses appVersion from Chart.yaml

imagePullSecrets:
  - name: "platform-image-pull-secret"

resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi

# =============================================================================
# OBSERVABILITY
# =============================================================================

metrics:
  enabled: true
  port: 9090
  path: "/metrics"
  serviceMonitor:
    enabled: false

# =============================================================================
# INGRESS CONFIGURATION
# =============================================================================

ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: "/$2"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "16k"
  hosts:
    - host: "governance.your-domain.com"
      paths:
        - path: "/authService(/|$)(.*)"
          pathType: ImplementationSpecific
  tls:
    - secretName: "governance-tls"
      hosts:
        - "governance.your-domain.com"

# =============================================================================
# HIGH AVAILABILITY
# =============================================================================

podDisruptionBudget:
  enabled: true
  minAvailable: 1

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - auth-service
          topologyKey: kubernetes.io/hostname
