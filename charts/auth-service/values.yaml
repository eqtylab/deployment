# Default values for auth-service.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# -- Enable the Auth Service
enabled: true

# -- Number of pod replicas to run (ignored if autoscaling.enabled is true)
replicaCount: 2

image:
  # -- Container image repository
  repository: ghcr.io/eqtylab/auth-service
  # -- Image pull policy (IfNotPresent | Always | Never)
  pullPolicy: IfNotPresent
  # -- Image tag override (defaults to chart appVersion if empty)
  tag: ""

# -- Image pull secrets for private registries
# @default -- Populated from global.secrets.imageRegistry.secretName in templates
imagePullSecrets: []

# -- Override the chart name used for resource naming
nameOverride: ""
# -- Override the full name used for resource naming
fullnameOverride: ""

serviceAccount:
  # -- Create a ServiceAccount for the deployment
  create: true
  # -- Automatically mount a ServiceAccount's API credentials
  automount: true
  # -- Annotations to add to the ServiceAccount
  annotations: {}
  # -- Name of an existing ServiceAccount to use (generated if empty and create is true)
  name: ""

# -- Additional annotations to add to pods
podAnnotations: {}

# -- Additional labels to add to pods
podLabels: {}

# -- Security context applied at the pod level
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

# -- Security context applied at the container level
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1000

service:
  # -- Create a Kubernetes Service
  enabled: true
  # -- Service type (ClusterIP | NodePort | LoadBalancer)
  type: ClusterIP
  # -- Service port
  port: 8080

ingress:
  # -- Create an Ingress resource for external access
  enabled: false
  # -- IngressClass name (e.g., "nginx", "traefik")
  className: ""
  # -- Additional annotations for the Ingress resource
  annotations: {}
    # cert-manager.io/cluster-issuer: "letsencrypt-prod"
    # nginx.ingress.kubernetes.io/rewrite-target: /$2
    # nginx.ingress.kubernetes.io/proxy-body-size: "64m"
  # -- Ingress host configuration
  hosts:
    - host: auth.example.com
      paths:
        - path: "/authService(/|$)(.*)"
          pathType: ImplementationSpecific
  # -- TLS configuration
  tls: []
    # - secretName: auth-service-tls
    #   hosts:
    #     - auth.example.com

# -- Resource requests and limits
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

# Horizontal Pod Autoscaler - automatically scales pods based on resource usage
autoscaling:
  # -- Enable Horizontal Pod Autoscaler
  enabled: false
  # -- Minimum number of replicas
  minReplicas: 2
  # -- Maximum number of replicas
  maxReplicas: 10
  # -- Target CPU utilization percentage
  targetCPUUtilizationPercentage: 80
  # -- Target memory utilization percentage
  targetMemoryUtilizationPercentage: 80

# Pod Disruption Budget - maintains availability during cluster disruptions
podDisruptionBudget:
  # -- Enable Pod Disruption Budget
  enabled: true
  # -- Minimum available pods during disruptions (only applied when autoscaling is enabled or replicaCount > 1)
  minAvailable: 1

# -- Node labels for pod assignment
nodeSelector: {}

# -- Tolerations for pod assignment
tolerations: []

# -- Affinity rules for pod assignment
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - auth-service
          topologyKey: kubernetes.io/hostname

# -- Startup probe configuration
startupProbe:
  httpGet:
    path: /health
    port: http
  failureThreshold: 30
  periodSeconds: 10

# -- Liveness probe configuration
livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

# -- Readiness probe configuration
readinessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3
  successThreshold: 1

# -- Additional volumes on the Deployment
volumes: []

# -- Additional volumeMounts on the Deployment
volumeMounts: []

# =============================================================================
# DATABASE CONFIGURATION
# =============================================================================

externalDatabase:
  # -- Database host
  # @default -- Populated from global.postgresql.host or generated as "{Release.Name}-postgresql" in templates
  host: ""
  # -- Database port
  # @default -- Populated from global.postgresql.port in templates
  port: ""
  # -- Database name
  # @default -- Populated from global.postgresql.database in templates
  name: ""
  # -- Database user
  # @default -- Populated from global.postgresql.username in templates
  user: ""
  # -- Database password (leave empty to use secret reference)
  password: ""
  # -- SSL mode (disable | require | verify-ca | verify-full)
  sslMode: "disable"
  # -- Maximum open connections
  maxOpenConns: 25
  # -- Maximum idle connections
  maxIdleConns: 5
  # -- Connection maximum lifetime
  connMaxLifetime: "5m"

  # Database password secret reference
  passwordSecretKeyRef:
    # -- Secret name containing database credentials
    # @default -- Populated from global.secrets.database.secretName in templates
    name: ""
    # -- Secret key name for database password
    # @default -- Populated from global.secrets.database.keys.password in templates
    key: ""

# Database migration configuration
migrations:
  # -- Run database migrations automatically at startup
  runAtStartup: true
  # -- Path to migration files within the container
  path: "/internal/database/migrations"

# =============================================================================
# SECRET CONFIGURATION
# =============================================================================

secrets:
  # Auth provider credentials (Auth0 or Keycloak)
  auth:
    # -- Secret name containing auth provider credentials
    # @default -- Populated from global.secrets.auth.auth0.secretName or global.secrets.auth.keycloak.secretName in templates
    name: ""
    # Secret keys
    keys:
      # -- Key for client ID
      # @default -- Populated from global.secrets.auth.auth0.keys.clientId or "client-id" in templates
      clientId: "client-id"
      # -- Key for client secret
      # @default -- Populated from global.secrets.auth.auth0.keys.clientSecret or "client-secret" in templates
      clientSecret: "client-secret"
      # -- Key for management client ID (Auth0 only, separate M2M app)
      # @default -- Populated from global.secrets.auth.auth0.keys.managementClientId or "mgmt-client-id" in templates
      managementClientId: "mgmt-client-id"
      # -- Key for management client secret (Auth0 only, separate M2M app)
      # @default -- Populated from global.secrets.auth.auth0.keys.managementClientSecret or "mgmt-client-secret" in templates
      managementClientSecret: "mgmt-client-secret"

  # Security secrets (API and JWT secrets)
  security:
    # -- Secret name containing security credentials
    # @default -- Populated from global.secrets.authService.secretName in templates
    name: ""
    # Secret keys
    keys:
      # -- Key for API secret
      apiSecret: "api-secret"
      # -- Key for JWT secret
      jwtSecret: "jwt-secret"

  # Session secret reference
  session:
    # -- Secret name containing session secret
    # @default -- Populated from global.secrets.authService.secretName in templates
    name: ""
    # Secret keys
    keys:
      # -- Key for session secret
      secret: "session-secret"

  # Azure Key Vault credentials (for DID key signing)
  keyVault:
    # -- Secret name containing Key Vault credentials
    # @default -- Populated from global.secrets.secretManager.azure_key_vault.secretName in templates
    name: ""
    # Secret keys
    keys:
      # -- Key for Azure client ID
      clientId: "client-id"
      # -- Key for Azure client secret
      clientSecret: "client-secret"
      # -- Key for Azure tenant ID
      tenantId: "tenant-id"
      # -- Key for vault URL
      vaultUrl: "vault-url"

  # Governance worker credentials
  worker:
    # -- Secret name containing worker credentials
    # @default -- Populated from global.secrets.governanceWorker.secretName in templates
    name: ""
    # Secret keys
    keys:
      # -- Key for encryption key
      encryptionKey: "encryption-key"
      # -- Key for client ID
      clientId: "client-id"
      # -- Key for client secret
      clientSecret: "client-secret"

  # Token exchange private key (for Keycloak token exchange)
  tokenExchange:
    # -- Secret name containing private key
    # @default -- Populated from global.secrets.authService.secretName in templates
    name: ""
    # Secret keys
    keys:
      # -- Key for private key
      privateKey: "private-key"

# =============================================================================
# APPLICATION CONFIGURATION
# =============================================================================

config:
  # Server configuration
  server:
    # -- Server port
    port: 8080
    # -- Server host
    host: "0.0.0.0"
    # -- Read timeout
    readTimeout: "30s"
    # -- Write timeout
    writeTimeout: "30s"
    # -- Idle timeout
    idleTimeout: "120s"
    # -- Environment (development | staging | production)
    # @default -- Populated from global.environmentType in templates
    environment: ""
    # -- Enable Swagger documentation
    swaggerEnabled: false

  # Logging configuration
  logging:
    # -- Log level (debug | info | warn | error)
    level: "info"
    # -- Log format (json | text)
    format: "json"
    # -- Paths to skip in access logs
    skipPaths: "/health,/health/live,/health/ready,/metrics"

  # CORS configuration
  cors:
    # -- Enable CORS (usually handled by ingress in k8s)
    enabled: false
    # -- Allowed origins
    origins: "*"

  # Identity provider configuration
  idp:
    # -- Identity provider type (auth0 | keycloak)
    # @default -- Populated from global.secrets.auth.provider in templates
    provider: ""
    # -- OIDC issuer URL
    # @default -- Generated from provider domain in templates
    issuer: ""
    # -- Skip issuer verification (DANGEROUS - only for development)
    skipIssuerVerification: false

    # Auth0 configuration (only used when provider is "auth0")
    auth0:
      # -- Auth0 tenant domain
      # @default -- `""` (**must be set** when provider is auth0)
      domain: ""
      # -- Enable Auth0 Management API
      enableManagementAPI: true
      # -- Management API audience
      # @default -- `""` (**must be set** when provider is auth0)
      managementAudience: ""
      # -- API identifier
      # @default -- `""` (**must be set** when provider is auth0)
      apiIdentifier: ""
      # -- Default connection for user creation
      defaultConnection: "Username-Password-Authentication"
      # -- Default roles for new users
      defaultRoles: ["user"]
      # -- Send invitation email on user creation
      sendInvitationEmail: true
      # -- Sync organizations at startup
      syncAtStartup: false
      # -- Page size for Auth0 API calls
      syncPageSize: 100

    # Keycloak configuration (only used when provider is "keycloak")
    keycloak:
      # -- Keycloak realm
      # @default -- Populated from global.secrets.auth.keycloak.values.realm in templates
      realm: ""
      # -- Keycloak admin URL (for admin operations)
      adminUrl: ""
      # -- Enable user management via Keycloak admin API
      enableUserManagement: false
      # -- Enable group sync with Keycloak
      enableGroupSync: false

  # Key Vault configuration
  keyVault:
    # -- Key Vault provider (azure | hashicorp | local)
    # @default -- Populated from global.secrets.secretManager.provider in templates
    provider: ""
    # -- DID Key cache TTL in minutes
    cacheTTLMinutes: 15

    # Azure Key Vault configuration (only used when provider is "azure")
    azure:
      # -- Azure Key Vault URL
      # @default -- Populated from global.secrets.secretManager.azure_key_vault.values.vaultUrl in templates
      vaultUrl: ""
      # -- Azure tenant ID
      # @default -- Populated from global.secrets.secretManager.azure_key_vault.values.tenantId in templates
      tenantId: ""

    # HashiCorp Vault configuration (only used when provider is "hashicorp")
    hashicorp:
      # -- Vault address
      address: ""

  # Service integration configuration
  integrations:
    # -- Integrity Service URL
    # @default -- Generated as "http://{Release.Name}-integrity-service:3050" in templates
    integrityServiceUrl: ""
    # -- Governance Service URL
    # @default -- Generated as "http://{Release.Name}-governance-service:10001" in templates
    governanceServiceUrl: ""

  # Service account configuration
  serviceAccounts:
    # -- Auto-create default service accounts on startup
    autoCreate: true

    # Governance Worker service account configuration
    governanceWorker:
      # -- Enable governance worker service account
      enabled: true
      # -- Service account name
      name: "governance-worker"
      # -- Service account description
      description: "Automated governance service worker for processing indicator evaluations"
      # -- Scopes for service account
      scopes:
        - "governance:declarations:create"
        - "integrity:statements:create"
      # -- Auth0 API audience for worker
      # @default -- `""` (must be set explicitly)
      audience: ""

  # Token exchange configuration
  tokenExchange:
    # -- Enable token exchange (for Keycloak integration)
    enabled: false
    # -- Key identifier for signing key
    keyId: "auth-service-prod-001"

  # RBAC configuration
  rbac:
    cache:
      # -- Enable RBAC permission cache
      enabled: true
      # -- Cache TTL
      ttl: "300s"
      # -- Maximum cache entries
      maxSize: 1000

  # Rate limiting configuration
  rateLimit:
    # -- Enable rate limiting
    enabled: false
    # -- Requests per minute
    requestsPerMinute: 60

# =============================================================================
# METRICS CONFIGURATION
# =============================================================================

metrics:
  # -- Enable Prometheus metrics
  enabled: false
  # -- Metrics port
  port: 9090
  # -- Metrics path
  path: /metrics
  serviceMonitor:
    # -- Enable ServiceMonitor for Prometheus Operator
    enabled: false
    # -- Scrape interval
    interval: "30s"
    # -- Scrape timeout
    scrapeTimeout: "10s"
    # -- Additional labels for ServiceMonitor
    labels: {}

# =============================================================================
# NETWORK POLICY CONFIGURATION
# =============================================================================

networkPolicy:
  # -- Enable NetworkPolicy
  enabled: false
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: governance-service
      ports:
        - protocol: TCP
          port: 8080
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: TCP
          port: 53
        - protocol: UDP
          port: 53
    # Allow PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: postgresql
      ports:
        - protocol: TCP
          port: 5432
    # Allow external HTTPS (for IDP communication)
    - to: []
      ports:
        - protocol: TCP
          port: 443
    # Allow internal service communication
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: integrity-service
      ports:
        - protocol: TCP
          port: 3050

# =============================================================================
# MIGRATION JOB CONFIGURATION
# =============================================================================

migration:
  # -- Enable migration as a Helm hook job
  enabled: false
  # -- Job backoff limit
  backoffLimit: 3
  # -- Job active deadline in seconds
  activeDeadlineSeconds: 300
  # -- TTL for completed jobs
  ttlSecondsAfterFinished: 300
  # -- Resources for migration job
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

# =============================================================================
# EXTRA CONFIGURATION
# =============================================================================

# -- Extra environment variables
extraEnvVars: []
  # - name: EXTRA_VAR
  #   value: "extra-value"

# -- Extra environment variables from Secret
extraEnvVarsSecret: ""

# -- Extra environment variables from ConfigMap
extraEnvVarsConfigMap: ""

# -- Extra containers to add to the pod
extraContainers: []

# -- Extra init containers to add to the pod
extraInitContainers: []

# -- Extra manifests to deploy
extraManifests: []
