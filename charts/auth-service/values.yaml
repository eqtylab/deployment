# Default values for auth-service.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

replicaCount: 1

image:
  repository: "ghcr.io/eqtylab/auth-service"
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: ""

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Automatically mount a ServiceAccount's API credentials?
  automount: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

podAnnotations: {}
podLabels: {}

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1000

service:
  type: ClusterIP
  port: 8080
  targetPort: http
  annotations: {}

ingress:
  enabled: false
  className: ""
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  hosts:
    - host: auth.local
      paths:
        - path: /
          pathType: ImplementationSpecific
  tls: []
  #  - secretName: auth-tls
  #    hosts:
  #      - auth.local

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

# Additional volumes on the output Deployment definition.
volumes: []
# - name: foo
#   secret:
#     secretName: mysecret
#     optional: false

# Additional volumeMounts on the output Deployment definition.
volumeMounts: []
# - name: foo
#   mountPath: "/etc/foo"
#   readOnly: true

nodeSelector: {}

tolerations: []

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - auth-service
          topologyKey: kubernetes.io/hostname

# Auth Service Configuration
config:
  # Server configuration
  server:
    port: 8080
    host: "0.0.0.0"
    readTimeout: 30s
    writeTimeout: 30s
    idleTimeout: 120s

  # Logging configuration
  logging:
    level: info
    format: json
    skipPaths: "/health,/health/live,/health/ready"

  # Identity Provider Configuration
  idp:
    # Provider type: generic, keycloak, zitadel, auth0
    provider: "generic"

    # Common OIDC settings (used by all providers)
    issuer: ""
    clientId: ""
    clientSecret: ""
    redirectUri: ""
    scopes: "openid,profile,email"

    # Use existing secret for IDP credentials
    existingSecret: "idp"
    # Keys in the existing secret
    existingSecretKeys:
      clientId: "client-id"
      clientSecret: "client-secret"
      managementClientId: "mgmt-client-id"
      managementClientSecret: "mgmt-client-secret"

    # Provider-specific configurations

    # Generic OIDC provider settings
    generic:
      # Claim mappings
      userIdClaim: "sub"
      emailClaim: "email"
      nameClaim: "name"
      rolesClaim: "roles"
      groupsClaim: "groups"
      # Manual endpoint configuration (if auto-discovery fails)
      authorizationEndpoint: ""
      tokenEndpoint: ""
      userinfoEndpoint: ""
      jwksEndpoint: ""

    # Keycloak-specific settings
    keycloak:
      realm: "master"
      adminUrl: ""
      # Admin credentials (not recommended for production)
      adminUsername: ""
      adminPassword: ""
      # Service account (recommended)
      serviceAccountClientId: ""
      serviceAccountClientSecret: ""
      # Feature flags
      enableUserManagement: false
      enableGroupSync: false

    # Zitadel-specific settings
    zitadel:
      projectId: ""
      organizationId: ""
      apiEndpoint: ""
      # Service account key (mounted as volume)
      serviceKeyPath: "/secrets/zitadel-key.json"
      enableWebhooks: false

    # Auth0-specific settings
    auth0:
      domain: ""
      # Management API settings
      enableManagementAPI: false # Set to true to enable Auth0 Management API
      managementClientId: ""
      managementClientSecret: ""
      managementAudience: ""
      # User creation settings
      defaultConnection: "Username-Password-Authentication"
      defaultRoles: ["user"]
      sendInvitationEmail: true
      # Custom domain (optional)
      customDomain: ""

    # Advanced settings
    httpTimeout: "30s"
    skipIssuerVerification: false
    skipClientIdCheck: false
    insecureSkipVerify: false
    cacheTTL: 3600
    maxRetries: 3

  # Database configuration
  database:
    host: "auth-service-postgresql"
    port: 5432
    name: "authservice"
    user: "authservice"
    password: ""
    sslMode: "disable"
    # Connection pool settings
    maxOpenConns: 25
    maxIdleConns: 5
    connMaxLifetime: "5m"
    # Migration settings
    autoMigrate: true
    migrationsPath: "/internal/database/migrations"
    # Use existing secret for database credentials
    existingSecret: ""
    # Keys in the existing secret
    existingSecretKeys:
      password: "password"

  # Key Vault configuration (for DID keys)
  keyVault:
    provider: "" # azure, hashicorp, local
    azure:
      tenant-id: ""
      vault-url: ""
      # Use existing secret for Azure credentials
      existingSecret: ""
      existingSecretKeys:
        clientId: "clientId"
        clientSecret: "clientSecret"

    hashicorp:
      address: ""
      token: ""
      # Use existing secret for Vault token
      existingSecret: ""
      existingSecretKeys:
        token: "token"

  # RBAC configuration
  rbac:
    # Cache settings
    cache:
      enabled: true
      ttl: 300s
      maxSize: 1000

  # CORS configuration
  cors:
    enabled: false # Set to false by default for k8s (ingress handles CORS)
    origins: "*" # Comma-separated list of allowed origins or "*" for all

  # Session configuration
  session:
    secret: ""
    duration: "24h"
    # Use existing secret for session secret
    existingSecret: ""
    existingSecretKeys:
      secret: "session-secret"

  # Rate limiting
  rateLimit:
    enabled: false
    requestsPerMinute: 60

# PostgreSQL subchart configuration
postgresql:
  enabled: true
  auth:
    username: authservice
    password: authservice
    database: authservice
  primary:
    persistence:
      enabled: true
      size: 10Gi
  metrics:
    enabled: false

# Redis subchart configuration (for caching/sessions)
redis:
  enabled: false
  auth:
    enabled: true
    password: ""
  master:
    persistence:
      enabled: false

# Health check configuration
healthCheck:
  liveness:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
    successThreshold: 1
  readiness:
    enabled: true
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
    successThreshold: 1

# Metrics configuration
metrics:
  enabled: false
  port: 9090
  path: /metrics
  serviceMonitor:
    enabled: false
    interval: 30s
    scrapeTimeout: 10s
    labels: {}

# Network policies
networkPolicy:
  enabled: false
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: governance-platform
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: TCP
          port: 53
        - protocol: UDP
          port: 53
    # Allow external HTTPS (for IDP communication)
    - to: []
      ports:
        - protocol: TCP
          port: 443

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1
  # maxUnavailable: 1

# Extra environment variables
extraEnvVars:
  # - name: API_SECRET
  #   valueFrom:
  #     secretKeyRef:
  #       name: auth-service-api-secret
  #       key: api-secret
  - name: API_SECRET
    value: "api-key"
  - name: ENVIRONMENT
    value: "development"
  - name: SWAGGER_ENABLED
    value: "true"
  - name: SWAGGER_BASE_PATH
    value: "/auth"
  - name: INTEGRITY_SERVICE_URL
    value: "http://localhost:3050"
# - name: EXTRA_VAR
#   value: "extra-value"

# Extra environment variables from secrets or configmaps
extraEnvVarsSecret: ""
extraEnvVarsConfigMap: ""

# Extra containers to add to the pod
extraContainers: []

# Extra init containers to add to the pod
extraInitContainers: []
# Example: Run migrations as init container (when autoMigrate is false)
# - name: run-migrations
#   image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
#   command: ["/migrate"]
#   env:
#     - name: DB_HOST
#       value: "{{ include \"auth-service.databaseHost\" . }}"
#     - name: DB_PORT
#       value: "{{ .Values.config.database.port }}"
#     - name: DB_NAME
#       value: "{{ .Values.config.database.name }}"
#     - name: DB_USER
#       value: "{{ .Values.config.database.user }}"
#     - name: DB_PASSWORD
#       valueFrom:
#         secretKeyRef:
#           name: "{{ include \"auth-service.databaseSecretName\" . }}"
#           key: "{{ include \"auth-service.databaseSecretKey\" . }}"
#     - name: DB_SSL_MODE
#       value: "{{ .Values.config.database.sslMode }}"
#     - name: DATABASE_MIGRATIONS_PATH
#       value: "/internal/database/migrations"

# Extra manifests to deploy
extraManifests: []

# Migration Job configuration
migration:
  enabled: false # Enable to run migrations as a Helm hook job
