{{- if .Values.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "auth-service.fullname" . }}
  labels:
    {{- include "auth-service.labels" . | nindent 4 }}
data:
  # ==========================================================================
  # Server Configuration
  # ==========================================================================
  PORT: "{{ .Values.config.server.port }}"
  HOST: "{{ .Values.config.server.host }}"
  ENVIRONMENT: "{{ .Values.config.server.environment | default ((.Values.global).environmentType) | default "production" }}"
  AUTH_SERVICE_URL: {{ .Values.config.server.authServiceUrl | default (printf "http://%s-auth-service:%s" .Release.Name (toString .Values.config.server.port)) | quote }}
  SWAGGER_ENABLED: "{{ .Values.config.server.swaggerEnabled }}"
  {{- if .Values.config.server.swaggerEnabled }}
  SWAGGER_HOST: "{{ .Values.config.server.swaggerHost | default ((.Values.global).domain) | default "" }}"
  SWAGGER_BASE_PATH: "{{ .Values.config.server.swaggerBasePath | default "/authService" }}"
  {{- end }}

  # ==========================================================================
  # Logging Configuration
  # ==========================================================================
  LOG_LEVEL: "{{ .Values.config.logging.level }}"
  LOG_FORMAT: "{{ .Values.config.logging.format }}"
  LOGGER_SKIP_PATHS: "{{ .Values.config.logging.skipPaths }}"

  # ==========================================================================
  # CORS Configuration
  # ==========================================================================
  CORS_ENABLED: "{{ .Values.config.cors.enabled }}"
  CORS_ORIGINS: "{{ .Values.config.cors.origins }}"

  # ==========================================================================
  # Database Configuration
  # ==========================================================================
  DB_HOST: "{{ .Values.externalDatabase.host | default ((.Values.global).postgresql).host | default (printf "%s-postgresql" .Release.Name) }}"
  DB_PORT: "{{ .Values.externalDatabase.port | default ((.Values.global).postgresql).port | default 5432 }}"
  DB_NAME: "{{ .Values.externalDatabase.name | default ((.Values.global).postgresql).database | default "governance" }}"
  DB_USER: "{{ .Values.externalDatabase.user | default ((.Values.global).postgresql).username | default "postgres" }}"
  DB_SSL_MODE: "{{ .Values.externalDatabase.sslMode }}"
  DATABASE_AUTO_MIGRATE: "{{ .Values.migrations.runAtStartup }}"
  DATABASE_MIGRATIONS_PATH: "{{ .Values.migrations.path }}"

  # ==========================================================================
  # Identity Provider Configuration
  # ==========================================================================
  {{- $idpProvider := .Values.config.idp.provider | default (((.Values.global).secrets).auth).provider | default "" }}
  IDP_PROVIDER: "{{ $idpProvider }}"
  {{- if .Values.config.idp.issuer }}
  IDP_ISSUER: "{{ .Values.config.idp.issuer }}"
  {{- end }}
  IDP_SKIP_ISSUER_VERIFICATION: "{{ .Values.config.idp.skipIssuerVerification }}"

  # Auth0 Configuration
  {{- if or (eq $idpProvider "auth0") (not $idpProvider) }}
  {{- if .Values.config.idp.auth0.domain }}
  IDP_AUTH0_DOMAIN: {{ .Values.config.idp.auth0.domain | quote }}
  {{- end }}
  {{- if .Values.config.idp.auth0.managementAudience }}
  IDP_AUTH0_MANAGEMENT_AUDIENCE: {{ .Values.config.idp.auth0.managementAudience | quote }}
  {{- end }}
  {{- if .Values.config.idp.auth0.apiIdentifier }}
  IDP_AUTH0_API_IDENTIFIER: "{{ .Values.config.idp.auth0.apiIdentifier }}"
  {{- end }}
  IDP_AUTH0_DEFAULT_CONNECTION: "{{ .Values.config.idp.auth0.defaultConnection }}"
  IDP_AUTH0_DEFAULT_ROLES: "{{ .Values.config.idp.auth0.defaultRoles | join "," }}"
  IDP_AUTH0_SEND_INVITATION_EMAIL: "{{ .Values.config.idp.auth0.sendInvitationEmail }}"
  {{- end }}

  # Keycloak Configuration
  {{- if eq $idpProvider "keycloak" }}
  {{- if .Values.config.idp.keycloak.realm }}
  IDP_KEYCLOAK_REALM: "{{ .Values.config.idp.keycloak.realm }}"
  {{- end }}
  {{- if .Values.config.idp.keycloak.adminUrl }}
  IDP_KEYCLOAK_ADMIN_URL: "{{ .Values.config.idp.keycloak.adminUrl }}"
  {{- end }}
  {{- if .Values.config.idp.keycloak.clientId }}
  IDP_CLIENT_ID: "{{ .Values.config.idp.keycloak.clientId }}"
  {{- end }}
  IDP_KEYCLOAK_ENABLE_USER_MANAGEMENT: "{{ .Values.config.idp.keycloak.enableUserManagement }}"
  IDP_KEYCLOAK_ENABLE_GROUP_SYNC: "{{ .Values.config.idp.keycloak.enableGroupSync }}"
  {{- end }}

  # Microsoft Entra ID Configuration
  {{- if eq $idpProvider "entra" }}
  {{- if .Values.config.idp.entra.tenantId }}
  IDP_ENTRA_TENANT_ID: {{ .Values.config.idp.entra.tenantId | quote }}
  {{- end }}
  {{- if .Values.config.idp.entra.defaultRoles }}
  IDP_ENTRA_DEFAULT_ROLES: {{ .Values.config.idp.entra.defaultRoles | quote }}
  {{- end }}
  {{- end }}

  # ==========================================================================
  # Key Vault Configuration
  # ==========================================================================
  {{- $keyVaultProvider := .Values.config.keyVault.provider | default (((.Values.global).secrets).secretManager).provider | default "" }}
  DID_KEY_CACHE_TTL_MINUTES: "{{ .Values.config.keyVault.cacheTTLMinutes }}"

  # Azure Key Vault Configuration
  {{- if or (eq $keyVaultProvider "azure") (eq $keyVaultProvider "azure_key_vault") }}
  {{- $vaultUrl := .Values.config.keyVault.azure.vaultUrl | default ((((.Values.global).secrets).secretManager).azure_key_vault).values.vaultUrl | default "" }}
  {{- if $vaultUrl }}
  AZURE_KEY_VAULT_URL: "{{ $vaultUrl }}"
  {{- end }}
  {{- $tenantId := .Values.config.keyVault.azure.tenantId | default ((((.Values.global).secrets).secretManager).azure_key_vault).values.tenantId | default "" }}
  {{- if $tenantId }}
  AZURE_TENANT_ID: "{{ $tenantId }}"
  {{- end }}
  {{- end }}

  # ==========================================================================
  # Service Account Configuration
  # ==========================================================================
  {{- if .Values.config.serviceAccounts.governanceWorker.enabled }}
  {{- $workerAudience := .Values.config.serviceAccounts.governanceWorker.audience | default (((((.Values.global).secrets).auth).auth0).management).audience | default "" }}
  {{- if $workerAudience }}
  AUTH0_GOVERNANCE_WORKER_AUDIENCE: "{{ $workerAudience }}"
  {{- end }}
  {{- end }}

  # ==========================================================================
  # Token Exchange Configuration
  # ==========================================================================
  {{- if .Values.config.tokenExchange.enabled }}
  AUTH_SERVICE_KEY_ID: "{{ .Values.config.tokenExchange.keyId }}"
  {{- end }}

  # ==========================================================================
  # Metrics Configuration
  # ==========================================================================
  {{- if .Values.metrics.enabled }}
  METRICS_ENABLED: "true"
  METRICS_PORT: "{{ .Values.metrics.port }}"
  METRICS_PATH: "{{ .Values.metrics.path }}"
  {{- end }}
{{- end }}
