# Keycloak Provider Configuration for Enterprise/On-Premises Deployment
# This values file configures the auth-service to use Keycloak as the identity provider

config:
  idp:
    provider: "keycloak"

    # Keycloak OIDC endpoint - this will be auto-discovered
    issuer: "https://keycloak.your-domain.com/realms/governance"

    # Frontend client for user authentication
    clientId: "governance-platform-frontend"
    clientSecret: "" # Not needed for public client

    # Redirect URI for the auth service
    redirectUri: "https://auth.your-domain.com/callback"

    # OIDC scopes
    scopes: "openid,profile,email,roles"

    # Keycloak-specific configuration
    keycloak:
      # Keycloak base URL
      realm: "governance"
      adminUrl: "https://keycloak.your-domain.com"

      # Service account for admin operations (user management)
      # This should be the backend client with service account enabled
      serviceAccountClientId: "governance-platform-backend"
      serviceAccountClientSecret: "" # Set via existingSecret

      # Feature flags
      enableUserManagement: true
      enableGroupSync: false # Groups managed in database, not Keycloak

    # Use existing secret for production
    existingSecret: "auth-service-keycloak-credentials"
    existingSecretKeys:
      clientId: "frontend-client-id"
      clientSecret: "frontend-client-secret"
      managementClientId: "backend-client-id"
      managementClientSecret: "backend-client-secret"

  # Service Account configuration for Keycloak
  serviceAccounts:
    autoCreate: true
    governanceWorker:
      enabled: true
      name: "governance-worker"
      description: "Automated governance service worker for processing indicator evaluations"
      organizationId: "" # Platform-wide access
      scopes:
        - "governance:declarations:create"
        - "integrity:statements:create"
      # Keycloak service account credentials
      keycloakClientId: "governance-worker"
      keycloakClientSecret: "" # Set via existingSecret

    # Use existing secret for service account credentials
    existingSecret: "governance-worker-credentials"
    existingSecretKeys:
      encryptionKey: "encryption-key"
      governanceWorkerClientId: "governance-worker-client-id"
      governanceWorkerClientSecret: "governance-worker-client-secret"

  # Database configuration for on-premises
  database:
    host: "postgresql.your-domain.local"
    port: 5432
    name: "auth_service"
    user: "auth_service_user"
    password: "" # Use existingSecret
    sslMode: "require" # Use SSL in production
    # Connection pool settings
    maxOpenConns: 25
    maxIdleConns: 5
    connMaxLifetime: "5m"
    # Use existing secret for credentials
    existingSecret: "auth-service-db-credentials"
    existingSecretKeys:
      password: "password"

  # Key Vault configuration for on-premises
  keyVault:
    provider: "hashicorp"
    cacheTTLMinutes: 15
    hashicorp:
      address: "https://vault.your-domain.local:8200"
      token: "" # Use existingSecret
      # Use existing secret for credentials
      existingSecret: "auth-service-vault-credentials"
      existingSecretKeys:
        token: "token"

  # Security configuration
  security:
    apiSecret: "" # Use existingSecret
    jwtSecret: "" # Use existingSecret
    existingSecret: "auth-service-security"
    existingSecretKeys:
      apiSecret: "api-secret"
      jwtSecret: "jwt-secret"

  # Integration URLs
  integrations:
    integrityServiceUrl: "http://integrity-service:8080"
    governanceServiceUrl: "http://governance-service:10001"

  # CORS configuration
  cors:
    enabled: true
    origins: "https://app.your-domain.com,https://app-staging.your-domain.com"

  # Session configuration
  session:
    secret: "" # Use existingSecret
    duration: "24h"
    existingSecret: "auth-service-session"
    existingSecretKeys:
      secret: "session-secret"

# Conservative settings for on-premises deployment
replicaCount: 2

autoscaling:
  enabled: false # Manual scaling for on-premises

resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 200m
    memory: 256Mi

# Enable metrics for monitoring
metrics:
  enabled: true
  port: 9090
  path: "/metrics"
  serviceMonitor:
    enabled: true
    interval: 30s
    labels:
      release: prometheus

# Health checks
healthCheck:
  liveness:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 10
  readiness:
    enabled: true
    initialDelaySeconds: 10
    periodSeconds: 5

# Ingress configuration for on-premises
ingress:
  enabled: true
  className: "nginx"
  annotations:
    # Use internal CA for on-premises
    cert-manager.io/cluster-issuer: "internal-ca"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "16k"
  hosts:
    - host: auth.your-domain.local
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: auth-service-tls
      hosts:
        - auth.your-domain.local

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Network Policy
networkPolicy:
  enabled: true
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: governance-service
      ports:
        - protocol: TCP
          port: 8080
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: TCP
          port: 53
        - protocol: UDP
          port: 53
    # Allow PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: postgresql
      ports:
        - protocol: TCP
          port: 5432
    # Allow Keycloak
    - to: []
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 8080
    # Allow Vault
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: vault
      ports:
        - protocol: TCP
          port: 8200

# Node selector for on-premises deployment
nodeSelector:
  node-role.kubernetes.io/worker: "true"

# Tolerations for on-premises deployment
tolerations: []

# Affinity rules for on-premises deployment
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - auth-service
          topologyKey: kubernetes.io/hostname

# Extra environment variables for Keycloak-specific settings
extraEnvVars:
  - name: IDP_KEYCLOAK_ENABLE_USER_MANAGEMENT
    value: "true"
  - name: IDP_KEYCLOAK_ENABLE_GROUP_SYNC
    value: "false"
  # Keycloak-specific service account credentials
  - name: KEYCLOAK_GOVERNANCE_WORKER_CLIENT_ID
    valueFrom:
      secretKeyRef:
        name: governance-worker-credentials
        key: keycloak-governance-worker-client-id
  - name: KEYCLOAK_GOVERNANCE_WORKER_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: governance-worker-credentials
        key: keycloak-governance-worker-client-secret
