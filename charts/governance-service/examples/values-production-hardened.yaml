# Production Hardened Configuration
# Maximum security configuration for production environments
#
# Usage:
#   helm install governance-service ./charts/governance-service -f examples/values-production-hardened.yaml
#
# This example demonstrates:
#   - Strict security contexts and pod security
#   - Network policies with least-privilege access
#   - Resource limits and quotas
#   - High availability with anti-affinity
#   - Comprehensive monitoring
#   - Read-only file systems
#   - Non-root execution

# =============================================================================
# APPLICATION CONFIGURATION
# =============================================================================

config:
  appEnv: "production"
  logLevel: "warn" # Minimal logging in production

  server:
    readTimeout: 15
    writeTimeout: 15
    idleTimeout: 60

  # Storage configuration
  storageProvider: "aws_s3"
  awsS3Region: "us-east-1"
  awsS3BucketName: "prod-governance-artifacts"
  awsS3Folder: "artifacts"

  # Auth0 configuration
  auth0Domain: "your-tenant.auth0.com"

  # Integration URLs
  integrityServiceUrl: "http://governance-platform-integrity-service:3050"
  authServiceUrl: "http://governance-platform-auth-service:8080"

  # Indicator configuration
  indicators:
    configPath: "/app/configs/indicators"
    reloadInterval: 600 # Less frequent in production
    osGuardrailsEnabled: false
    osGuardrailsBatchSize: 50
    osGuardrailsTimeoutSeconds: 3

  # Service account
  serviceAccount:
    enabled: true
    serviceName: "governance-worker"

  # AI features
  ai:
    enabled: true
    provider: "anthropic"
    model: "claude-3-7-sonnet-latest"
    temperature: 0.5 # More deterministic in production
    maxTokens: 4000
    timeoutSeconds: 30
    retryAttempts: 2
    useV2: true

auth0SyncAtStartup: false # Run separately
auth0SyncPageSize: 50

# =============================================================================
# DATABASE CONFIGURATION
# =============================================================================

externalDatabase:
  host: "prod-postgres.internal"
  port: 5432
  database: "governance"
  user: "governance_prod"
  sslmode: "verify-full"

  passwordSecretKeyRef:
    name: "prod-database-credentials"
    key: "password"

migrations:
  runAtStartup: false # Run migrations separately
  path: "/app/migrations"

# =============================================================================
# SECRET CONFIGURATION
# =============================================================================

secrets:
  encryption:
    name: "prod-encryption"

  auth0:
    name: "prod-auth0"

  storage:
    aws_s3:
      name: "prod-aws-s3"

  worker:
    name: "prod-governance-worker"

# =============================================================================
# DEPLOYMENT CONFIGURATION
# =============================================================================

replicaCount: 5

image:
  repository: ghcr.io/eqtylab/governance-service
  pullPolicy: Always
  tag: "1.0.0" # Pin to specific version

imagePullSecrets:
  - name: "prod-registry-credentials"

serviceAccount:
  create: true
  automount: false # Disable auto-mount for security
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/governance-service-prod"
  name: "governance-service-prod"

# =============================================================================
# SECURITY CONTEXTS (HARDENED)
# =============================================================================

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 65534
  runAsGroup: 65534
  fsGroup: 65534
  fsGroupChangePolicy: "OnRootMismatch"
  seccompProfile:
    type: RuntimeDefault

securityContext:
  allowPrivilegeEscalation: false
  privileged: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 65534
  runAsGroup: 65534
  seccompProfile:
    type: RuntimeDefault

# =============================================================================
# RESOURCE CONFIGURATION (HARDENED)
# =============================================================================

resources:
  requests:
    cpu: 500m
    memory: 512Mi
    ephemeral-storage: "100Mi"
  limits:
    cpu: 2000m
    memory: 2Gi
    ephemeral-storage: "500Mi"

autoscaling:
  enabled: true
  minReplicas: 5
  maxReplicas: 20
  targetCPUUtilizationPercentage: 60
  targetMemoryUtilizationPercentage: 70

# =============================================================================
# INGRESS CONFIGURATION (HARDENED)
# =============================================================================

ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-Frame-Options "DENY" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    nginx.ingress.kubernetes.io/limit-rps: "20"
    nginx.ingress.kubernetes.io/limit-connections: "10"
    nginx.ingress.kubernetes.io/proxy-body-size: "32m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "10"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "30"
  hosts:
    - host: governance.production-domain.com
      paths:
        - path: "/governanceService(/|$)(.*)"
          pathType: ImplementationSpecific
  tls:
    - secretName: governance-service-prod-tls
      hosts:
        - governance.production-domain.com

# =============================================================================
# HIGH AVAILABILITY (HARDENED)
# =============================================================================

podDisruptionBudget:
  minAvailable: 3

affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
                - governance-service
        topologyKey: "kubernetes.io/hostname"
      - labelSelector:
          matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
                - governance-service
        topologyKey: "topology.kubernetes.io/zone"

nodeSelector:
  node-type: "production"

tolerations:
  - key: "production"
    operator: "Equal"
    value: "true"
    effect: "NoSchedule"

# =============================================================================
# PROBES (CONSERVATIVE)
# =============================================================================

startupProbe:
  httpGet:
    path: /health
    port: http
  failureThreshold: 60
  periodSeconds: 5

livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 60
  periodSeconds: 15
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# =============================================================================
# POD LABELS AND ANNOTATIONS
# =============================================================================

podLabels:
  security.kubernetes.io/audit: "true"
  environment: "production"

podAnnotations:
  seccomp.security.alpha.kubernetes.io/pod: runtime/default
  container.apparmor.security.beta.kubernetes.io/governance-service: runtime/default
