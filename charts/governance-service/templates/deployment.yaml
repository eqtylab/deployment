{{- if .Values.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "governance-service.fullname" . }}
  labels:
    {{- include "governance-service.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "governance-service.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        {{- with .Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "governance-service.selectorLabels" . | nindent 8 }}
        {{- with .Values.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- if and .Values.global (((.Values.global).secrets).imageRegistry).secretName }}
      imagePullSecrets:
        - name: {{ ((.Values.global).secrets).imageRegistry.secretName }}
      {{- else if .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.imagePullSecrets | nindent 8 }}
      {{- end }}
      {{- if or .Values.serviceAccount.create .Values.serviceAccount.name }}
      serviceAccountName: {{ .Values.serviceAccount.name | default (include "governance-service.fullname" .) }}
      {{- end }}
      {{- with .Values.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: {{ .Chart.Name }}
          {{- with .Values.securityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy | default ((.Values.global).imagePullPolicy | default "IfNotPresent") }}
          command: {{ .Values.command }}
          args: {{ .Values.args }}
          envFrom:
            - configMapRef:
                name: {{ include "governance-service.fullname" . }}
          env:
          # ========================================================================
          # Application Configuration
          # ========================================================================
          
          - name: LOG_LEVEL
            value: {{ .Values.config.logLevel | quote }}
          - name: APP_ENV
            value: {{ .Values.config.appEnv | default ((.Values.global).environmentType | default "") | quote }}

          # ========================================================================
          # Database Configuration
          # ========================================================================
          
          - name: DB_HOST
            value: {{ .Values.externalDatabase.host | default (((.Values.global).postgresql).host) | default (printf "%s-postgresql" .Release.Name) | quote }}
          - name: DB_PORT
            value: {{ .Values.externalDatabase.port | quote }}
          - name: DB_NAME
            value: {{ .Values.externalDatabase.database | quote }}
          - name: DB_USER
            value: {{ .Values.externalDatabase.user | quote }}
          - name: DB_PASSWORD
            {{- if .Values.externalDatabase.password }}
            value: {{ .Values.externalDatabase.password | quote }}
            {{- else }}
            valueFrom:
              secretKeyRef:
                name: {{ .Values.externalDatabase.passwordSecretKeyRef.name | default (((.Values.global).secrets).database).secretName | quote }}
                key: {{ .Values.externalDatabase.passwordSecretKeyRef.key | default ((((.Values.global).secrets).database).keys).password | quote }}
            {{- end }}
          - name: DB_SSLMODE
            value: {{ .Values.externalDatabase.sslmode | quote }}

          # ========================================================================
          # Storage Configuration
          # ========================================================================
          
          {{- $storageProvider := .Values.config.storageProvider }}
          {{- if $storageProvider }}
          - name: STORAGE_PROVIDER
            value: {{ $storageProvider | quote }}
          {{- end }}

          {{- if eq $storageProvider "gcs" }}
          # GCS Configuration
          - name: GCS_BUCKET_NAME
            value: {{ .Values.config.gcsBucketName | quote }}
          - name: GCS_CREDENTIALS_FILE
            value: "/var/secrets/google/service-account.json"
          {{- end }}

          {{- if eq $storageProvider "azure_blob" }}
          # Azure Blob Storage Configuration
          {{- $azureSecretName := .Values.secrets.storage.azure_blob.name | default ((((.Values.global).secrets).storage).azure_blob).secretName | default "" }}
          - name: AZURE_STORAGE_ACCOUNT_NAME
            {{- if .Values.config.azureStorageAccountName }}
            value: {{ .Values.config.azureStorageAccountName | quote }}
            {{- else }}
            valueFrom:
              secretKeyRef:
                name: {{ $azureSecretName | quote }}
                key: {{ (((((.Values.global).secrets).storage).azure_blob).keys).accountName | default "account-name" | quote }}
            {{- end }}
          - name: AZURE_STORAGE_ACCOUNT_KEY
            {{- if .Values.config.azureStorageAccountKey }}
            value: {{ .Values.config.azureStorageAccountKey | quote }}
            {{- else }}
            valueFrom:
              secretKeyRef:
                name: {{ $azureSecretName | quote }}
                key: {{ (((((.Values.global).secrets).storage).azure_blob).keys).accountKey | default "account-key" | quote }}
            {{- end }}
          {{- if or .Values.config.azureStorageConnectionString $azureSecretName }}
          - name: AZURE_STORAGE_CONNECTION_STRING
            {{- if .Values.config.azureStorageConnectionString }}
            value: {{ .Values.config.azureStorageConnectionString | quote }}
            {{- else }}
            valueFrom:
              secretKeyRef:
                name: {{ $azureSecretName | quote }}
                key: {{ (((((.Values.global).secrets).storage).azure_blob).keys).connectionString | default "connection-string" | quote }}
            {{- end }}
          {{- end }}
          - name: AZURE_STORAGE_CONTAINER_NAME
            value: {{ .Values.config.azureStorageContainerName | quote }}
          - name: AZURE_USE_MANAGED_IDENTITY
            value: {{ .Values.config.azureUseManagedIdentity | quote }}
          {{- end }}

          {{- if eq $storageProvider "aws_s3" }}
          # AWS S3 Configuration
          {{- $s3SecretName := .Values.secrets.storage.aws_s3.name | default ((((.Values.global).secrets).storage).aws_s3).secretName | default "" }}
          - name: AWS_REGION
            value: {{ .Values.config.awsS3Region | quote }}
          - name: AWS_S3_BUCKET
            value: {{ .Values.config.awsS3BucketName | quote }}
          {{- if .Values.config.awsS3Folder }}
          - name: AWS_S3_FOLDER
            value: {{ .Values.config.awsS3Folder | quote }}
          {{- end }}
          - name: AWS_ACCESS_KEY_ID
            {{- if .Values.config.awsS3AccessKeyId }}
            value: {{ .Values.config.awsS3AccessKeyId | quote }}
            {{- else }}
            valueFrom:
              secretKeyRef:
                name: {{ $s3SecretName | quote }}
                key: {{ (((((.Values.global).secrets).storage).aws_s3).keys).accessKeyId | default "access-key-id" | quote }}
            {{- end }}
          - name: AWS_SECRET_ACCESS_KEY
            {{- if .Values.config.awsS3SecretAccessKey }}
            value: {{ .Values.config.awsS3SecretAccessKey | quote }}
            {{- else }}
            valueFrom:
              secretKeyRef:
                name: {{ $s3SecretName | quote }}
                key: {{ (((((.Values.global).secrets).storage).aws_s3).keys).secretAccessKey | default "secret-access-key" | quote }}
            {{- end }}
          {{- end }}

          # ========================================================================
          # Authentication Configuration
          # ========================================================================

          {{- $authProvider := (((.Values.global).secrets).auth).provider | default "auth0" }}

          {{- if eq $authProvider "auth0" }}
          # Auth0 Configuration
          {{- $auth0SecretName := .Values.secrets.auth.auth0.name | default ((((.Values.global).secrets).auth).auth0).secretName | default "" }}
          {{- if .Values.config.auth0Domain }}
          - name: AUTH0_DOMAIN
            value: {{ .Values.config.auth0Domain | quote }}
          {{- end }}
          - name: AUTH0_CLIENT_ID
            {{- if .Values.config.auth0ClientId }}
            value: {{ .Values.config.auth0ClientId | quote }}
            {{- else }}
            valueFrom:
              secretKeyRef:
                name: {{ $auth0SecretName | quote }}
                key: {{ (((((.Values.global).secrets).auth).auth0).keys).clientId | default "client-id" | quote }}
            {{- end }}
          - name: AUTH0_CLIENT_SECRET
            {{- if .Values.config.auth0ClientSecret }}
            value: {{ .Values.config.auth0ClientSecret | quote }}
            {{- else }}
            valueFrom:
              secretKeyRef:
                name: {{ $auth0SecretName | quote }}
                key: {{ (((((.Values.global).secrets).auth).auth0).keys).clientSecret | default "client-secret" | quote }}
            {{- end }}
          - name: AUTH0_SYNC_AT_STARTUP
            value: {{ .Values.auth0SyncAtStartup | quote }}
          - name: AUTH0_SYNC_PAGE_SIZE
            value: {{ .Values.auth0SyncPageSize | quote }}
          {{- end }}

          {{- if eq $authProvider "keycloak" }}
          # Keycloak Configuration
          {{- $keycloakSecretName := .Values.secrets.auth.keycloak.name | default ((((.Values.global).secrets).auth).keycloak).secretName | default "" }}
          - name: KEYCLOAK_URL
            valueFrom:
              secretKeyRef:
                name: {{ $keycloakSecretName | quote }}
                key: {{ (((((.Values.global).secrets).auth).keycloak).keys).url | default "url" | quote }}
          - name: KEYCLOAK_REALM
            valueFrom:
              secretKeyRef:
                name: {{ $keycloakSecretName | quote }}
                key: {{ (((((.Values.global).secrets).auth).keycloak).keys).realm | default "realm" | quote }}
          - name: KEYCLOAK_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: {{ $keycloakSecretName | quote }}
                key: {{ (((((.Values.global).secrets).auth).keycloak).keys).backendClientId | default "backend-client-id" | quote }}
          - name: KEYCLOAK_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: {{ $keycloakSecretName | quote }}
                key: {{ (((((.Values.global).secrets).auth).keycloak).keys).backendClientSecret | default "backend-client-secret" | quote }}
          {{- end }}

          # ========================================================================
          # Encryption Configuration
          # ========================================================================

          - name: CREDENTIAL_ENCRYPTION_KEY
            valueFrom:
              secretKeyRef:
                name: {{ .Values.secrets.encryption.name | default (((.Values.global).secrets).encryption).secretName | default "" | quote }}
                key: {{ ((((.Values.global).secrets).encryption).keys).key | default "encryption-key" | quote }}

          # ========================================================================
          # Integration URLs
          # ========================================================================
          
          - name: INTEGRITY_SERVICE_URL
            value: {{ .Values.config.integrityServiceUrl | default (printf "https://%s/integrityService" ((.Values.global).domain | default "")) | quote }}
          - name: AUTH_SERVICE_URL
            value: {{ .Values.config.authServiceUrl | default (printf "https://%s/authService" ((.Values.global).domain | default "")) | quote }}

          # ========================================================================
          # Worker Configuration
          # ========================================================================

          {{- if .Values.config.serviceAccount.enabled }}
          {{- $workerSecretName := .Values.secrets.worker.name | default (((.Values.global).secrets).governanceWorker).secretName | default "" }}
          - name: WORKER_ENCRYPTION_KEY
            valueFrom:
              secretKeyRef:
                name: {{ $workerSecretName | quote }}
                key: {{ ((((.Values.global).secrets).governanceWorker).keys).encryptionKey | default "encryption-key" | quote }}
          - name: WORKER_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: {{ $workerSecretName | quote }}
                key: {{ ((((.Values.global).secrets).governanceWorker).keys).clientId | default "client-id" | quote }}
          - name: WORKER_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: {{ $workerSecretName | quote }}
                key: {{ ((((.Values.global).secrets).governanceWorker).keys).clientSecret | default "client-secret" | quote }}
          - name: AUTH_SERVICE_API_KEY
            valueFrom:
              secretKeyRef:
                {{- if .Values.config.serviceAccount.existingSecret }}
                name: {{ .Values.config.serviceAccount.existingSecret | quote }}
                key: {{ .Values.config.serviceAccount.existingSecretKeys.apiKey | quote }}
                {{- else }}
                name: {{ include "governance-service.fullname" . }}-service-account
                key: auth-service-api-key
                {{- end }}
          {{- end }}

          # ========================================================================
          # Migration Configuration
          # ========================================================================
          
          {{- if .Values.migrations }}
          - name: MIGRATIONS_RUN_AT_STARTUP
            value: {{ .Values.migrations.runAtStartup | quote }}
          - name: MIGRATIONS_PATH
            value: {{ .Values.migrations.path | quote }}
          {{- end }}

          # ========================================================================
          # AI Configuration
          # ========================================================================

          {{- if .Values.config.ai.enabled }}
          - name: AI_ENABLED
            value: {{ .Values.config.ai.enabled | quote }}
          - name: AI_API_KEY
            {{- if .Values.config.ai.apiKey }}
            value: {{ .Values.config.ai.apiKey | quote }}
            {{- else }}
            valueFrom:
              secretKeyRef:
                name: {{ .Values.config.ai.secretKeyRef.name | default (((.Values.global).secrets).governanceServiceAI).secretName | default "" | quote }}
                key: {{ ((((.Values.global).secrets).governanceServiceAI).keys).apiKey | default "api-key" | quote }}
            {{- end }}
          - name: AI_PROVIDER
            value: {{ .Values.config.ai.provider | quote }}
          - name: AI_MODEL
            value: {{ .Values.config.ai.model | quote }}
          - name: AI_TEMPERATURE
            value: {{ .Values.config.ai.temperature | quote }}
          - name: AI_MAX_TOKENS
            value: {{ .Values.config.ai.maxTokens | quote }}
          - name: AI_TIMEOUT_SECONDS
            value: {{ .Values.config.ai.timeoutSeconds | quote }}
          - name: AI_RETRY_ATTEMPTS
            value: {{ .Values.config.ai.retryAttempts | quote }}
          - name: AI_USE_V2
            value: {{ .Values.config.ai.useV2 | quote }}
          {{- end }}

          # ========================================================================
          # Indicator Configuration
          # ========================================================================
          
          - name: ENABLE_OS_GUARDRAIL_EVENTS
            value: {{ .Values.config.indicators.osGuardrailsEnabled | quote }}
          {{- if .Values.config.indicators.osGuardrailsEnabled }}
          - name: GUARDRAIL_EVENT_BATCH_SIZE
            value: {{ .Values.config.indicators.osGuardrailsBatchSize | quote }}
          - name: GUARDRAIL_EVENT_TIMEOUT_SECONDS
            value: {{ .Values.config.indicators.osGuardrailsTimeoutSeconds | quote }}
          {{- end }}

          # TODO: Remove this once it is already enforced on the backend, this is a bandaid.
          - name: INDICATORS_V2_ENABLED
            value: "true"

          volumeMounts:
            {{- if eq $storageProvider "gcs" }}
            - name: gcs-sa-volume
              mountPath: /var/secrets/google
              readOnly: true
            {{- end }}
          ports:
            - name: http
              containerPort: {{ .Values.service.port }}
              protocol: TCP
          {{- with .Values.startupProbe }}
          startupProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.livenessProbe }}
          livenessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.readinessProbe }}
          readinessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
      volumes:
        {{- if eq $storageProvider "gcs" }}
        - name: gcs-sa-volume
          secret:
            secretName: {{ .Values.secrets.storage.gcs.name | default ((((.Values.global).secrets).storage).gcs).secretName | default "" | quote }}
            items:
              - key: {{ (((((.Values.global).secrets).storage).gcs).keys).serviceAccountJson | default "service-account-json" | quote }}
                path: "service-account.json"
        {{- end }}
{{- end }}
