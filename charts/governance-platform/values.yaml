# =============================================================================
# GOVERNANCE STUDIO PLATFORM - HELM VALUES CONFIGURATION
# =============================================================================
# This values file configures the complete Governance Studio platform including
# all microservices, databases, and infrastructure components.
#
# IMPORTANT: This file contains example values. For production deployments:
# 1. Copy this file and customize for your environment
# 2. NEVER commit actual secrets to version control
# 3. Use a separate secrets file for sensitive values
# 4. Override the 'domain' value with your actual domain
# =============================================================================

# =============================================================================
# GLOBAL CONFIGURATION
# =============================================================================
# Global settings that are shared across all components in the platform
global:
  # --- Environment Configuration ---
  # Defines the deployment environment type, affects logging, security, and performance settings
  environmentType: "production" # Options: development, staging, production

  # Base domain for all ingress hostnames - MUST be overridden for your environment
  # This domain will be used by all services for external access
  domain: "governance.example.com" # Example: governance.yourcompany.com

  # Default image pull policy for all containers
  # IfNotPresent: Only pull if image doesn't exist locally (recommended for tagged releases)
  # Always: Always pull the latest version (use for 'latest' tags or development)
  # Never: Never pull, use local image only
  imagePullPolicy: "IfNotPresent"

  # --- Secrets Management ---
  # Centralized secret configuration for all platform components
  # Secrets can be created automatically by the chart or pre-created manually
  secrets:
    # --- Secret Names ---
    # These names are used to reference secrets across all components
    # Change these if you want to use different secret names in your cluster
    complianceSecretName: "compliance-secrets" # Database credentials, API keys for Compliance Garage
    auth0SecretName: "auth0-secret" # Auth0 authentication credentials
    blobStoreSecretName: "blob-secret" # Cloud storage credentials (Azure/GCS/AWS)
    azureKVSecretName: "azure-kv-secret" # Azure Key Vault access credentials
    huggingFaceSecretName: "hf-secret" # Hugging Face model access token
    encryptionKeySecretName: "platform-encryption" # Platform encryption keys
    imagePullSecretName: "ghcr-pull-secret" # Container registry credentials
    openaiSecretName: "openai-secret" # OpenAI API key for AI features
    authServiceDbSecretName: "auth-service-db-credentials" # Auth service database credentials
    authServiceSessionSecretName: "auth-service-session-secret" # Auth service session secret
    authServiceApiSecretName: "auth-service-api-secret" # Auth service API secret
    authServiceKeysSecretName: "auth-service-keys" # Auth service private keys for token signing
    governanceWorkerSecretName: "governance-worker-credentials" # Governance worker service account

    # --- Secret Creation Control ---
    # true: Chart will create secrets using the values below during installation
    # false: Secrets must be created manually before chart installation
    # RECOMMENDATION: Use false for production and create secrets via CI/CD or manually
    createSecrets: true

    # Secret values - these will be used to create secrets if createSecrets is true
    # For production use, do NOT include these values in your values.yaml file
    # Instead, use --set-file or a dedicated values file that is not checked into source control
    values:
      # Compliance Garage secrets
      compliance:
        # Database connection string (used by all Compliance Garage components)
        databaseUrl: "" # e.g., postgresql://postgres:password@postgresql:5432/governance
        # Redis connection string
        redisUrl: "" # e.g., redis://redis-master:6379
        # Gemini API key for AI features
        geminiApiKey: ""

      # Auth0 authentication (only needed when using Auth0, not Keycloak)
      auth0:
        clientId: ""
        clientSecret: ""
        domain: "" # e.g., your-tenant.us.auth0.com

      # Database credentials
      database:
        postgresPassword: "" # Password for PostgreSQL database
        redisPassword: "" # Password for Redis

      # Blob storage
      blobStorage:
        # For GCP
        gcsServiceAccountJson: "" # Base64-encoded service account JSON
        # For Azure
        azureStorageAccountName: ""
        azureStorageAccountKey: ""
        connectionString: ""
        emailString: ""
        # For AWS
        awsAccessKeyId: ""
        awsSecretAccessKey: ""

      # Azure Key Vault
      azureKeyVault:
        clientId: ""
        clientSecret: ""
        tenantId: ""
        vaultUrl: ""

      # AI/ML credentials
      huggingFace:
        token: ""

      # OpenAI credentials
      openai:
        apiKey: ""

      # Platform encryption
      encryption:
        key: "" # Encryption key for sensitive data
        azureKeyVaultUrl: ""
        azureKeyVaultClientId: ""
        azureKeyVaultClientSecret: ""
        azureKeySecretName: ""
        azureKeyVaultTenantId: ""

      # Container registry credentials
      imagePull:
        username: "" # GitHub username or token name
        password: "" # GitHub PAT with read:packages scope
        email: "" # Email associated with GitHub account

      # Auth Service specific secrets
      authService:
        dbPassword: "" # Database password for auth service (can be same as postgresPassword)
        sessionSecret: "" # Session secret for auth service (generate with: openssl rand -base64 32)
        apiSecret: "" # API secret for auth service (generate with: openssl rand -base64 32)
        jwtSecret: "" # JWT secret for auth service (generate with: openssl rand -base64 32)
        privateKey: "" # Private key for token signing (PEM format) - used for Keycloak token exchange

      # Governance Worker Service Account
      governanceWorker:
        encryptionKey: "" # Encryption key for service accounts (generate with: openssl rand -base64 32)
        clientId: "" # Auth0/Keycloak application client ID for governance worker (if Keycloak, use 'governance-worker')
        clientSecret: "" # Auth0/Keycloak application client secret for governance worker

      # Keycloak-specific secrets (when using Keycloak instead of Auth0)
      keycloak:
        # Frontend client (public client)
        frontendClientId: "governance-platform-frontend" # Usually doesn't need to be changed

        # Backend client (confidential client for auth-service)
        backendClientId: "governance-platform-backend" # Usually doesn't need to be changed
        backendClientSecret: "" # Required: Secret for backend client (generate with: openssl rand -hex 32)

  # --- Database Configuration ---
  # PostgreSQL connection settings shared across all platform services
  # These values create a consistent database connection configuration
  postgresql:
    host: "{{ .Release.Name }}-postgresql" # Automatically resolves to deployed PostgreSQL service
    port: 5432 # Standard PostgreSQL port
    database: "governance" # Default database name (additional DBs created via initdb)
    username: "postgres" # PostgreSQL admin user
    # Note: Password is retrieved from the compliance-secrets secret for security

  # --- Redis Configuration ---
  # Redis connection settings for caching and message queuing
  # Used primarily by Compliance Garage components
  redis:
    host: "{{ .Release.Name }}-redis-master" # Automatically resolves to deployed Redis master service
    port: 6379 # Standard Redis port
    # Note: Password is retrieved from secrets if authentication is enabled

  # --- Container Registry Configuration ---
  # Uncomment and set if using a private container registry instead of GitHub Container Registry
  # imageRegistry: "mycompany.registry.io/governance-platform"

  # Image pull secrets for accessing private container registries
  # These secrets must exist in the namespace before deployment
  imagePullSecrets:
    - name: "ghcr-pull-secret" # Required for GitHub Container Registry access

  # --- Default Resource Configuration ---
  # Default CPU and memory limits/requests applied to all components
  # Individual components can override these values in their specific configuration
  defaultResources:
    requests:
      cpu: "100m" # Minimum CPU allocation (0.1 CPU core)
      memory: "256Mi" # Minimum memory allocation
    limits:
      cpu: "500m" # Maximum CPU allocation (0.5 CPU core)
      memory: "512Mi" # Maximum memory allocation

  # --- Storage Configuration ---
  # Default storage class for all persistent volumes
  # Leave empty ("") to use the cluster's default storage class
  # Examples: "gp2" (AWS), "pd-standard" (GCP), "azure-disk" (Azure)
  defaultStorageClass: ""

  # --- Ingress Configuration ---
  # Centralized ingress configuration shared across all platform services
  # All services will be accessible through path-based routing on a single domain
  ingress:
    enabled: true # Enable ingress for external access
    className: "nginx" # Ingress controller class (nginx, traefik, etc.)

    # Ingress annotations for common configurations
    annotations:
      cert-manager.io/issuer: letsencrypt-prod # Automatic TLS certificate issuer
      nginx.ingress.kubernetes.io/use-regex: "true" # Enable regex matching for paths
      nginx.ingress.kubernetes.io/enable-cors: "true" # Enable CORS for cross-origin requests
      nginx.ingress.kubernetes.io/proxy-body-size: "64m" # Maximum request body size

    host: "governance.example.com" # MUST be overridden with your actual domain
    tlsSecretName: "platform-tls" # Kubernetes secret name for TLS certificates

# =============================================================================
# COMPONENT CONFIGURATION
# =============================================================================
# Configuration for individual platform components
# Each component can be enabled/disabled and customized independently

# --- Component: Governance Service ---
# Core governance platform with API and Worker services
# API provides REST endpoints, Worker processes background jobs
governance-service:
  enabled: true # Set to false to disable the Governance Service component

  # === API Service Configuration ===
  api:
    replicaCount: 1
    image:
      repository: "ghcr.io/eqtylab/governance-service"
      tag: "1.0.0"
      pullPolicy: "IfNotPresent"
    command: ["./governance-service"]
    args: []
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 250m
        memory: 256Mi

  # === Worker Service Configuration ===
  worker:
    replicaCount: 1
    image:
      repository: "ghcr.io/eqtylab/governance-worker"
      tag: "1.0.0"
      pullPolicy: "IfNotPresent"
    command: ["./governance-worker"]
    args: []
    resources:
      limits:
        cpu: 1000m
        memory: 1Gi
      requests:
        cpu: 500m
        memory: 512Mi

  # === Shared Configuration ===
  imagePullSecrets:
    - name: ghcr-pull-secret

  # Service configuration
  service:
    type: ClusterIP
    port: 10001

  ingress:
    enabled: true
    className: "nginx"
    annotations:
      cert-manager.io/issuer: "letsencrypt-prod"
      nginx.ingress.kubernetes.io/use-regex: "true"
      nginx.ingress.kubernetes.io/rewrite-target: "/$2"
      nginx.ingress.kubernetes.io/enable-cors: "true"
      nginx.ingress.kubernetes.io/proxy-body-size: "64m"
    hosts:
      - host: "governance.example.com"
        paths:
          - path: "/governanceService(/|$)(.*)"
            pathType: "ImplementationSpecific"
    tls:
      - secretName: "platform-tls"
        hosts:
          - "governance.example.com"

  # Kubernetes deployment settings
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 100
    targetCPUUtilizationPercentage: 80

  nodeSelector: {}
  tolerations: []
  affinity: {}

  # Pod settings
  podAnnotations: {}
  podSecurityContext: {}
  securityContext:
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    runAsUser: 1000

  # Service Account Configuration
  serviceAccount:
    create: false
    name: "blob-secret"

  # Configure external database settings
  externalDatabase:
    host: "governance-platform-postgresql"
    port: 5432
    database: "governance"
    user: "postgres"
    sslmode: "disable"
    # Password comes from secret
    passwordSecretKeyRef:
      name: "compliance-secrets"
      key: "postgresPassword"

  migrations:
    runAtStartup: true
    path: "/app/migrations"

  # Application configuration
  config:
    logLevel: "info"
    appEnv: "production"

    # Storage provider configuration
    storageProvider: "gcs" # Options: "gcs" or "azure"

    # Google Cloud Storage Configuration
    gcsBucketName: "" # Set if using GCS

    # Azure Storage Configuration
    azureStorageAccountName: "" # Azure storage account name
    azureStorageAccountKey: "" # Azure storage account key (prefer using secret reference)
    azureStorageConnectionString: "" # Azure storage connection string (prefer using secret reference)
    azureStorageContainerName: "" # Azure storage container name
    azureUseManagedIdentity: false # Use Azure managed identity for authentication

    # Auth0 configuration
    auth0Domain: "governance-studio.us.auth0.com"

    # Service URLs
    integrityServiceUrl: "http://governance-platform-integrity-service"
    authServiceUrl: "http://governance-platform-auth-service:8080"

    # Service account configuration
    serviceAccount:
      enabled: true
      authServiceUrl: "http://governance-platform-auth-service:8080"

  # Azure Storage Secret Reference (recommended for production)
  azureStorageSecretKeyRef:
    name: "blob-secret" # Uses the blob storage secret from global secrets
    accountNameKey: "azure-storage-account-name"
    accountKeyKey: "azure-storage-account-key"
    connectionStringKey: "connection-string"

  # Auth0 Secret Reference (only used when not using Keycloak)
  auth0SecretKeyRef:
    name: ""
    clientIdKey: ""
    clientSecretKey: ""

  # Keycloak Configuration (when using Keycloak instead of Auth0)
  keycloakSecretKeyRef:
    enabled: false # Set to true when using Keycloak
    existingSecret: "keycloak-worker-config"
    existingSecretKeys:
      clientId: "KEYCLOAK_CLIENT_ID"
      realm: "KEYCLOAK_REALM"
      url: "KEYCLOAK_URL"
    existingClientSecretKeyRef:
      name: "keycloak-worker-client"
      clientSecretKey: "client-secret"

  # HuggingFace Token Secret Reference
  huggingFaceTokenSecretKeyRef:
    name: "hf-secret"
    key: "token"

  # Credential Encryption Key Secret Reference
  credentialEncryptionKeySecretKeyRef:
    name: "platform-encryption"
    key: "key"

auth-service:
  enabled: true # Set to false to disable the Auth Service component
  config:
    server:
      port: 8080
      host: "0.0.0.0"
      environment: "production"
      swaggerEnabled: true # Enable swagger for non-production environments

    logging:
      level: info
      format: json
      skipPaths: "/health,/health/live,/health/ready"

    idp:
      provider: "auth0"
      issuer: "https://governance-studio.us.auth0.com/"
      clientId: "" # Will use secret
      clientSecret: "" # Will use secret
      existingSecret: "auth0-secret"
      skipIssuerVerification: true

      auth0:
        domain: "governance-studio.us.auth0.com"
        enableManagementAPI: true # Enable Auth0 Management API
        managementAudience: "https://governance-studio.us.auth0.com/api/v2/"
        apiIdentifier: "https://governance-studio.us.auth0.com/api/v2/"
        defaultConnection: "Username-Password-Authentication"
        defaultRoles: ["user"]
        sendInvitationEmail: true
        syncAtStartup: true
        syncPageSize: 100

    # Service Account configuration
    serviceAccounts:
      autoCreate: true
      governanceWorker:
        enabled: true
        name: "governance-worker"
        description: "Automated governance service worker for processing indicator evaluations"
        # No organizationId - platform-wide access
        scopes:
          - "governance:declarations:create"
          - "integrity:statements:create"
        # Auth0 M2M credentials will be provided via secret
        auth0ClientId: "" # Will use secret
        auth0ClientSecret: "" # Will use secret
        audience: "https://governance.eqtylab.io" # Your API audience in Auth0
      # Generate a secure encryption key: openssl rand -base64 32
      # encryptionKey: "your-base64-encoded-32-byte-key"
      existingSecret: "governance-worker-credentials"
      existingSecretKeys:
        encryptionKey: "key"
        governanceWorkerClientId: "governance-worker-client-id"
        governanceWorkerClientSecret: "governance-worker-client-secret"

    database:
      host: "governance-platform-postgresql"
      port: 5432
      name: "governance"
      user: "postgres"
      sslMode: "disable" # Internal cluster communication
      maxOpenConns: 25
      maxIdleConns: 5
      connMaxLifetime: "5m"
      existingSecret: "auth-service-db-credentials"
      # Migration settings
      autoMigrate: true # Run migrations on startup
      migrationsPath: "/internal/database/migrations" # Path in container

    session:
      duration: "24h"
      existingSecret: "auth-service-session-secret"

    cors:
      enabled: false # Ingress handles CORS in k8s
      origins: "*" # Not used when enabled=false

    # Security configuration
    security:
      # These will be provided via extraEnvVars from existing secrets
      apiSecret: ""
      jwtSecret: ""

    # Integration with other services
    integrations:
      # Integrity Service URL (for DID key fallback)
      integrityServiceUrl: "http://governance-platform-integrity-service"
      # Governance Service URL
      governanceServiceUrl: "http://governance-platform-governance-service:10001"

    # Key Vault configuration (for DID keys)
    keyVault:
      provider: "azure" # azure, hashicorp, local
      azure:
        vaultUrl: "https://example-kv.vault.azure.net/"
        tenantId: "example-tenant-id"
        clientId: "" # Will use secret
        clientSecret: "" # Will use secret
        # Use existing secret for Azure credentials
        existingSecret: "platform-encryption"
        existingSecretKeys:
          clientId: "azure-key-vault-client-id"
          clientSecret: "azure-key-vault-client-secret"

  ingress:
    enabled: true
    className: "nginx"
    annotations:
      cert-manager.io/issuer: "letsencrypt-prod"
      nginx.ingress.kubernetes.io/use-regex: "true"
      nginx.ingress.kubernetes.io/rewrite-target: "/$2"
      nginx.ingress.kubernetes.io/enable-cors: "true"
      nginx.ingress.kubernetes.io/proxy-body-size: "64m"
    hosts:
      - host: "governance.example.com"
        paths:
          - path: "/auth(/|$)(.*)"
            pathType: "ImplementationSpecific"
    tls:
      - secretName: "platform-tls"
        hosts:
          - "governance.example.com"

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  autoscaling:
    enabled: false # Enable later if needed
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 80

  postgresql:
    enabled: false # Using existing PostgreSQL in cluster

  healthCheck:
    liveness:
      enabled: true
      initialDelaySeconds: 30
      periodSeconds: 10
    readiness:
      enabled: true
      initialDelaySeconds: 10
      periodSeconds: 5

  metrics:
    enabled: false
    port: 9090
    path: /metrics

  extraEnvVars:
    - name: API_SECRET
      valueFrom:
        secretKeyRef:
          name: auth-service-api-secret
          key: api-secret
    - name: SWAGGER_BASE_PATH
      value: "/auth"

# =============================================================================
# INFRASTRUCTURE COMPONENTS
# =============================================================================
# Database and infrastructure services required by the platform

# --- PostgreSQL Configuration ---
# Primary database for all platform services
# Automatically creates separate databases for each component
postgresql:
  enabled: true # Set to false to use an external PostgreSQL instance
  # Global PostgreSQL values
  global:
    defaultStorageClass: ""
    postgresql:
      auth:
        database: "governance"
        username: "postgres"
        existingSecret: "{{ .Values.global.secrets.complianceSecretName }}"
        secretKeys:
          adminPasswordKey: "postgresPassword"
          userPasswordKey: "postgresPassword"
  # Primary PostgreSQL instance configuration
  primary:
    persistence:
      enabled: true
      size: 10Gi
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2000m
        memory: 2Gi
    # Initialize additional databases beyond the default 'governance' database
    initdb:
      scripts:
        create-additional-dbs.sql: |
          CREATE DATABASE governance;
          GRANT ALL PRIVILEGES ON DATABASE governance TO postgres;

          CREATE DATABASE "IntegrityServiceDB";
          GRANT ALL PRIVILEGES ON DATABASE "IntegrityServiceDB" TO postgres;

# =============================================================================
# KEYCLOAK INTEGRATION
# =============================================================================
# Configuration for Keycloak identity provider integration
# This creates the necessary organization in the governance database
keycloak:
  # Enable automatic organization creation for Keycloak realm
  createOrganization: false # Set to true to create org on install/upgrade

  # Realm name in Keycloak (must match the organization name in database)
  realmName: "governance"

  # Display name for the organization
  displayName: "Governance Platform"

  # Create platform-admin user in auth service tables
  createPlatformAdmin: false # Set to true to create platform admin user

  # Keycloak user ID for platform-admin (will be set by bootstrap)
  # Leave empty to auto-generate, or set after running Keycloak bootstrap
  platformAdminKeycloakId: ""

  # Additional organization settings (optional)
  organizationSettings:
    description: "Main governance organization"
    settings: "{}" # JSON string for additional settings
