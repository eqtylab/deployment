# =============================================================================
# GOVERNANCE PLATFORM - AZURE DEPLOYMENT EXAMPLE
# =============================================================================
# Complete example for deploying the Governance Platform on Microsoft Azure
# using AKS (Azure Kubernetes Service) with Azure Blob Storage.
#
# PREREQUISITES:
#   - AKS cluster with ingress-nginx installed
#   - Azure Storage Account with containers for governance and integrity
#   - Azure Key Vault for credential signing
#   - Auth0 tenant configured (or Keycloak)
#   - cert-manager installed for TLS certificates
#
# USAGE:
#   1. Copy this file and customize for your environment
#   2. Create secrets using the commands at the bottom of this file
#   3. Deploy:
#      helm dependency update ./charts/governance-platform
#      helm install governance-platform ./charts/governance-platform \
#        --namespace governance \
#        --create-namespace \
#        --values values-azure-example.yaml
# =============================================================================

# =============================================================================
# GLOBAL CONFIGURATION
# =============================================================================
global:
  # Your Azure domain - update this to your actual domain
  domain: "governance.yourcompany.com"
  environmentType: "production"
  imagePullPolicy: "IfNotPresent"

  # ---------------------------------------------------------------------------
  # Secret Configuration
  # ---------------------------------------------------------------------------
  # Set create: false for production - create secrets manually before deployment
  # See the SECRET CREATION COMMANDS section at the bottom of this file
  secrets:
    create: false

    # Database credentials
    database:
      secretName: "platform-database"

    # Authentication - Auth0
    auth:
      provider: "auth0"
      auth0:
        secretName: "platform-auth0"

    # Auth service credentials
    authService:
      secretName: "platform-auth-service"

    # Storage - Azure Blob Storage
    storage:
      azure_blob:
        secretName: "platform-azure-blob"

    # Secret Manager - Azure Key Vault
    secretManager:
      provider: "azure_key_vault"
      azure_key_vault:
        enabled: true
        secretName: "platform-azure-key-vault"

    # Platform encryption
    encryption:
      secretName: "platform-encryption-key"

    # Governance worker credentials
    governanceWorker:
      secretName: "platform-governance-worker"

    # AI service credentials (optional)
    governanceServiceAI:
      secretName: "platform-governance-service-ai"

    # Image registry credentials
    imageRegistry:
      secretName: "platform-image-pull-secret"
      registry: "ghcr.io"

# =============================================================================
# GOVERNANCE STUDIO (Frontend)
# =============================================================================
governance-studio:
  enabled: true
  replicaCount: 2

  ingress:
    enabled: true
    className: "nginx"
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
      nginx.ingress.kubernetes.io/proxy-body-size: "64m"
    hosts:
      - host: governance.yourcompany.com
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: governance-studio-tls
        hosts:
          - governance.yourcompany.com

  config:
    # Auth0 SPA settings (public, not secrets)
    auth0Domain: "your-tenant.us.auth0.com"
    auth0ClientId: "your-spa-client-id"
    auth0Audience: "https://your-tenant.us.auth0.com/api/v2/"

    appTitle: "Governance Studio"
    features:
      governance: true
      lineage: true
      guardianEnabled: false
      agentManagement: false
    branding:
      logoUrl: "/vite.svg"
      primaryColor: "#0f172a"
      companyName: "Your Company"

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 80

# =============================================================================
# GOVERNANCE SERVICE (Backend API)
# =============================================================================
governance-service:
  enabled: true
  replicaCount: 2

  # Uncomment to use Azure Workload Identity instead of static credentials
  # serviceAccount:
  #   create: true
  #   annotations:
  #     azure.workload.identity/client-id: YOUR_MANAGED_IDENTITY_CLIENT_ID
  # podAnnotations:
  #   azure.workload.identity/use: "true"

  ingress:
    enabled: true
    className: "nginx"
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
      nginx.ingress.kubernetes.io/use-regex: "true"
      nginx.ingress.kubernetes.io/rewrite-target: "/$2"
      nginx.ingress.kubernetes.io/proxy-body-size: "64m"
    hosts:
      - host: governance.yourcompany.com
        paths:
          - path: "/governanceService(/|$)(.*)"
            pathType: ImplementationSpecific
    tls:
      - secretName: governance-service-tls
        hosts:
          - governance.yourcompany.com

  # Storage configuration - Azure Blob Storage
  config:
    logLevel: "info"

    # Azure Blob Storage
    storageProvider: "azure_blob"
    azureStorageContainerName: "governance-attachments" # Your container name
    azureUseManagedIdentity: false # Set to true if using Workload Identity

    # AI features
    ai:
      enabled: true
      provider: "anthropic"
      model: "claude-sonnet-4-20250514"

    # Service account for governance worker
    serviceAccount:
      enabled: true
      serviceName: "governance-worker"

  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 80

# =============================================================================
# INTEGRITY SERVICE (Credentials & Lineage)
# =============================================================================
integrity-service:
  enabled: true
  replicaCount: 2

  # Uncomment to use Azure Workload Identity instead of static credentials
  # serviceAccount:
  #   create: true
  #   annotations:
  #     azure.workload.identity/client-id: YOUR_MANAGED_IDENTITY_CLIENT_ID
  # podAnnotations:
  #   azure.workload.identity/use: "true"

  ingress:
    enabled: true
    className: "nginx"
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
      nginx.ingress.kubernetes.io/use-regex: "true"
      nginx.ingress.kubernetes.io/rewrite-target: "/$2"
      nginx.ingress.kubernetes.io/proxy-body-size: "64m"
    hosts:
      - host: governance.yourcompany.com
        paths:
          - path: "/integrityService(/|$)(.*)"
            pathType: ImplementationSpecific
    tls:
      - secretName: integrity-service-tls
        hosts:
          - governance.yourcompany.com

  # Storage configuration - Azure Blob Storage
  config:
    integrityAppLoggingLogLevelDefault: "info"

    # Azure Blob Storage
    integrityAppBlobStoreType: "azure_blob"
    integrityAppBlobStoreAccount: "yourstorageaccount" # Your storage account name
    integrityAppBlobStoreContainer: "integrity-data" # Your container name

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 80

# =============================================================================
# AUTH SERVICE
# =============================================================================
auth-service:
  enabled: true
  replicaCount: 2

  ingress:
    enabled: true
    className: "nginx"
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
      nginx.ingress.kubernetes.io/use-regex: "true"
      nginx.ingress.kubernetes.io/rewrite-target: "/$2"
      nginx.ingress.kubernetes.io/proxy-body-size: "64m"
    hosts:
      - host: governance.yourcompany.com
        paths:
          - path: "/authService(/|$)(.*)"
            pathType: ImplementationSpecific
    tls:
      - secretName: auth-service-tls
        hosts:
          - governance.yourcompany.com

  config:
    server:
      environment: "production"
      swaggerEnabled: false

    logging:
      level: "info"
      format: "json"

    idp:
      provider: "auth0"
      auth0:
        domain: "your-tenant.us.auth0.com"
        managementAudience: "https://your-tenant.us.auth0.com/api/v2/"

    database:
      autoMigrate: true

    # Azure Key Vault configuration for DID keys
    keyVault:
      provider: "azure"
      azure:
        vaultUrl: "https://your-vault.vault.azure.net/"
        tenantId: "your-azure-tenant-id"

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 80

# =============================================================================
# POSTGRESQL
# =============================================================================
postgresql:
  enabled: true

  global:
    postgresql:
      auth:
        database: "governance"
        username: "postgres"
        existingSecret: "platform-database"
        secretKeys:
          adminPasswordKey: "password"
          userPasswordKey: "password"

  primary:
    persistence:
      enabled: true
      size: 50Gi
      # Use Azure managed-premium storage class for better performance
      storageClass: "managed-premium"

    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2000m
        memory: 4Gi
# =============================================================================
# ALTERNATIVE: Using Azure Database for PostgreSQL Instead of PostgreSQL Pod
# =============================================================================
# For production, consider using Azure Database for PostgreSQL:
#
# postgresql:
#   enabled: false  # Disable in-cluster PostgreSQL
#
# global:
#   postgresql:
#     host: "your-server.postgres.database.azure.com"
#     port: 5432
#     database: "governance"
#     username: "postgres@your-server"
#
# Then create your database secret with the Azure PostgreSQL password.

# =============================================================================
# SECRET CREATION COMMANDS FOR AZURE
# =============================================================================
# Run these commands before deploying:
#
# # Create namespace
# kubectl create namespace governance
#
# # Database credentials
# kubectl create secret generic platform-database \
#   --from-literal=username=postgres \
#   --from-literal=password="$(openssl rand -base64 24)" \
#   --namespace governance
#
# # Auth0 credentials
# kubectl create secret generic platform-auth0 \
#   --from-literal=client-id=YOUR_AUTH0_CLIENT_ID \
#   --from-literal=client-secret=YOUR_AUTH0_CLIENT_SECRET \
#   --from-literal=mgmt-client-id=YOUR_AUTH0_MGMT_CLIENT_ID \
#   --from-literal=mgmt-client-secret=YOUR_AUTH0_MGMT_CLIENT_SECRET \
#   --namespace governance
#
# # Auth service secrets
# kubectl create secret generic platform-auth-service \
#   --from-literal=db-password="$(openssl rand -base64 24)" \
#   --from-literal=session-secret="$(openssl rand -base64 32)" \
#   --from-literal=api-secret="$(openssl rand -base64 32)" \
#   --from-literal=jwt-secret="$(openssl rand -base64 32)" \
#   --namespace governance
#
# # Azure Blob Storage credentials (skip if using Workload Identity)
# kubectl create secret generic platform-azure-blob \
#   --from-literal=account-name=yourstorageaccount \
#   --from-literal=account-key=YOUR_STORAGE_ACCOUNT_KEY \
#   --from-literal=connection-string="DefaultEndpointsProtocol=https;AccountName=yourstorageaccount;AccountKey=YOUR_KEY;EndpointSuffix=core.windows.net" \
#   --namespace governance
#
# # Azure Key Vault credentials
# kubectl create secret generic platform-azure-key-vault \
#   --from-literal=client-id=YOUR_AZURE_CLIENT_ID \
#   --from-literal=client-secret=YOUR_AZURE_CLIENT_SECRET \
#   --from-literal=tenant-id=YOUR_AZURE_TENANT_ID \
#   --from-literal=vault-url=https://your-vault.vault.azure.net/ \
#   --namespace governance
#
# # Encryption key
# kubectl create secret generic platform-encryption-key \
#   --from-literal=encryption-key="$(openssl rand -base64 32)" \
#   --namespace governance
#
# # Governance worker credentials
# kubectl create secret generic platform-governance-worker \
#   --from-literal=encryption-key="$(openssl rand -base64 32)" \
#   --from-literal=client-id=YOUR_M2M_CLIENT_ID \
#   --from-literal=client-secret=YOUR_M2M_CLIENT_SECRET \
#   --namespace governance
#
# # AI credentials (optional)
# kubectl create secret generic platform-governance-service-ai \
#   --from-literal=api-key=YOUR_ANTHROPIC_API_KEY \
#   --namespace governance
#
# # Image pull secret
# kubectl create secret docker-registry platform-image-pull-secret \
#   --docker-server=ghcr.io \
#   --docker-username=YOUR_GITHUB_USERNAME \
#   --docker-password=YOUR_GITHUB_PAT \
#   --docker-email=YOUR_EMAIL \
#   --namespace governance

# =============================================================================
# AZURE-SPECIFIC CONSIDERATIONS
# =============================================================================
#
# 1. Workload Identity (Recommended)
#    Instead of using static credentials, use Azure Workload Identity.
#    Uncomment the serviceAccount sections above and configure:
#
#    # Create User Assigned Managed Identity
#    az identity create --name governance-identity --resource-group YOUR_RG
#
#    # Get the identity client ID
#    CLIENT_ID=$(az identity show --name governance-identity --resource-group YOUR_RG --query clientId -o tsv)
#
#    # Grant storage permissions
#    az role assignment create \
#      --assignee $CLIENT_ID \
#      --role "Storage Blob Data Contributor" \
#      --scope /subscriptions/SUB_ID/resourceGroups/RG/providers/Microsoft.Storage/storageAccounts/ACCOUNT
#
#    # Federate the identity with the Kubernetes service account
#    az identity federated-credential create \
#      --name governance-federated \
#      --identity-name governance-identity \
#      --resource-group YOUR_RG \
#      --issuer $(az aks show -n CLUSTER -g RG --query oidcIssuerProfile.issuerUrl -o tsv) \
#      --subject system:serviceaccount:governance:governance-service
#
# 2. Azure Application Gateway Ingress Controller (AGIC)
#    If using AGIC instead of nginx ingress:
#
#    ingress:
#      className: "azure/application-gateway"
#      annotations:
#        appgw.ingress.kubernetes.io/ssl-redirect: "true"
#        appgw.ingress.kubernetes.io/backend-path-prefix: "/"
#
# 3. Azure Database for PostgreSQL
#    For production, use Azure Database for PostgreSQL Flexible Server.
#    See the "Using Azure Database for PostgreSQL" section above.
#
# 4. Azure Key Vault Provider for Secrets Store CSI Driver
#    Consider using the Secrets Store CSI Driver with Azure Key Vault
#    for enhanced secret management:
#
#    # Install Secrets Store CSI Driver with Azure Key Vault Provider
#    helm install csi-secrets-store secrets-store-csi-driver/secrets-store-csi-driver \
#      --namespace kube-system
#
#    # Then use SecretProviderClass to sync secrets from Key Vault
#    # https://azure.github.io/secrets-store-csi-driver-provider-azure/
#
# 5. Azure Monitor Integration
#    Enable Azure Monitor for containers in your AKS cluster for
#    comprehensive logging and monitoring of the platform:
#
#    az aks enable-addons -a monitoring -n CLUSTER -g RG
#
# 6. Storage Account Configuration
#    Ensure your Azure Storage Account has appropriate settings:
#    - Enable soft delete for blob protection
#    - Configure lifecycle management for cost optimization
#    - Enable infrastructure encryption for compliance
#    - Restrict network access using service endpoints or private endpoints
