# Enablement Check
{{- if and .Values.global.secrets.create (index .Values "auth-service" "enabled") (eq .Values.global.secrets.auth.provider "keycloak") }}

# Data Validation
{{- if not (index .Values "auth-service" "secrets" "signing" "secretName") }}
  {{- fail "auth-service.secrets.signing.secretName is required when auth-service is enabled, create is true, and provider is keycloak" }}
{{- end }}
{{- if not (index .Values "auth-service" "secrets" "signing" "values" "privateKey") }}
  {{- fail "auth-service.secrets.signing.values.privateKey is required when auth-service is enabled and provider is keycloak (generate RSA key pair)" }}
{{- end }}
{{- if not (index .Values "auth-service" "secrets" "signing" "values" "publicKey") }}
  {{- fail "auth-service.secrets.signing.values.publicKey is required when auth-service is enabled and provider is keycloak (generate RSA key pair)" }}
{{- end }}

# Secret Resource
apiVersion: v1
kind: Secret
metadata:
  name: {{ index .Values "auth-service" "secrets" "signing" "secretName" }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "governance-platform.labels" . | nindent 4 }}
type: Opaque
stringData:
  {{ index .Values "auth-service" "secrets" "signing" "keys" "privateKey" }}: {{ index .Values "auth-service" "secrets" "signing" "values" "privateKey" | quote }}
  {{ index .Values "auth-service" "secrets" "signing" "keys" "publicKey" }}: {{ index .Values "auth-service" "secrets" "signing" "values" "publicKey" | quote }}
{{- end }}
