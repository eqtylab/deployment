{{- if .Values.keycloak.createOrganization }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "governance-platform.fullname" . }}-create-keycloak-org
  labels:
    {{- include "governance-platform.labels" . | nindent 4 }}
    app.kubernetes.io/component: keycloak-org-setup
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "20"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        {{- include "governance-platform.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: keycloak-org-setup
    spec:
      restartPolicy: OnFailure
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: create-org
          image: postgres:15-alpine
          command: ["/bin/sh"]
          args:
            - -c
            - |
              set -e
              echo "Waiting for database to be ready..."
              until pg_isready -h {{ .Values.postgresql.host | default (printf "%s-postgresql" .Release.Name) }} -p 5432 -U {{ .Values.postgresql.auth.username }}; do
                echo "Database not ready yet..."
                sleep 5
              done
              
              echo "Creating Keycloak organization..."
              
              # Check if organization already exists
              EXISTS=$(psql -h {{ .Values.postgresql.host | default (printf "%s-postgresql" .Release.Name) }} \
                -U {{ .Values.postgresql.auth.username }} \
                -d {{ .Values.postgresql.auth.database }} \
                -t -c "SELECT COUNT(*) FROM organization WHERE name = '{{ .Values.keycloak.realmName }}';" | tr -d ' ')
              
              if [ "$EXISTS" = "1" ]; then
                echo "Organization '{{ .Values.keycloak.realmName }}' already exists"
                # Update to ensure idp_provider is set correctly
                psql -h {{ .Values.postgresql.host | default (printf "%s-postgresql" .Release.Name) }} \
                  -U {{ .Values.postgresql.auth.username }} \
                  -d {{ .Values.postgresql.auth.database }} \
                  -c "UPDATE organization SET idp_provider = 'keycloak', updated_at = NOW() WHERE name = '{{ .Values.keycloak.realmName }}';"
                echo "Updated organization to use Keycloak IDP"
              else
                # Create new organization
                psql -h {{ .Values.postgresql.host | default (printf "%s-postgresql" .Release.Name) }} \
                  -U {{ .Values.postgresql.auth.username }} \
                  -d {{ .Values.postgresql.auth.database }} \
                  -c "INSERT INTO organization (name, description, display_name, idp_provider, settings, created_at, updated_at) \
                      VALUES ('{{ .Values.keycloak.realmName }}', '{{ .Values.keycloak.realmName }}', '{{ .Values.keycloak.displayName | default .Values.keycloak.realmName }}', 'keycloak', '{}', NOW(), NOW());"
                echo "Created organization '{{ .Values.keycloak.realmName }}'"
              fi
              
              # Show the organization
              psql -h {{ .Values.postgresql.host | default (printf "%s-postgresql" .Release.Name) }} \
                -U {{ .Values.postgresql.auth.username }} \
                -d {{ .Values.postgresql.auth.database }} \
                -c "SELECT id, name, display_name, idp_provider FROM organization WHERE name = '{{ .Values.keycloak.realmName }}';"
              
              {{- if .Values.keycloak.createPlatformAdmin }}
              echo "Creating platform-admin user..."
              
              # Generate UUIDs
              USER_ID=$(uuidgen | tr '[:upper:]' '[:lower:]')
              KEYCLOAK_USER_ID="{{ .Values.keycloak.platformAdminKeycloakId | default "00000000-0000-0000-0000-000000000000" }}"
              
              # Check if user exists
              USER_EXISTS=$(psql -h {{ .Values.postgresql.host | default (printf "%s-postgresql" .Release.Name) }} \
                -U {{ .Values.postgresql.auth.username }} \
                -d {{ .Values.postgresql.auth.database }} \
                -t -c "SELECT COUNT(*) FROM users WHERE email = 'admin@{{ .Values.keycloak.realmName }}.local';" | tr -d ' ')
              
              if [ "$USER_EXISTS" = "1" ]; then
                echo "Platform admin user already exists"
                USER_ID=$(psql -h {{ .Values.postgresql.host | default (printf "%s-postgresql" .Release.Name) }} \
                  -U {{ .Values.postgresql.auth.username }} \
                  -d {{ .Values.postgresql.auth.database }} \
                  -t -c "SELECT id FROM users WHERE email = 'admin@{{ .Values.keycloak.realmName }}.local';" | tr -d ' ')
              else
                # Create user
                psql -h {{ .Values.postgresql.host | default (printf "%s-postgresql" .Release.Name) }} \
                  -U {{ .Values.postgresql.auth.username }} \
                  -d {{ .Values.postgresql.auth.database }} \
                  -c "INSERT INTO users (id, idp_provider, idp_user_id, email, email_verified, display_name, given_name, family_name, active, app_metadata, created_at, updated_at, is_service_account, service_config) \
                      VALUES ('$USER_ID', 'keycloak', '$KEYCLOAK_USER_ID', 'admin@{{ .Values.keycloak.realmName }}.local', true, 'Platform Admin', 'Platform', 'Admin', true, '{}', NOW(), NOW(), false, '{}');"
                echo "Created platform admin user"
              fi
              
              # Get organization ID
              ORG_ID=$(psql -h {{ .Values.postgresql.host | default (printf "%s-postgresql" .Release.Name) }} \
                -U {{ .Values.postgresql.auth.username }} \
                -d {{ .Values.postgresql.auth.database }} \
                -t -c "SELECT id FROM organization WHERE name = '{{ .Values.keycloak.realmName }}';" | tr -d ' ')
              
              # Check if membership exists
              MEMBERSHIP_EXISTS=$(psql -h {{ .Values.postgresql.host | default (printf "%s-postgresql" .Release.Name) }} \
                -U {{ .Values.postgresql.auth.username }} \
                -d {{ .Values.postgresql.auth.database }} \
                -t -c "SELECT COUNT(*) FROM user_organization_memberships WHERE user_id = '$USER_ID' AND organization_id = $ORG_ID;" | tr -d ' ')
              
              if [ "$MEMBERSHIP_EXISTS" = "1" ]; then
                echo "Membership already exists, updating to ensure owner role"
                psql -h {{ .Values.postgresql.host | default (printf "%s-postgresql" .Release.Name) }} \
                  -U {{ .Values.postgresql.auth.username }} \
                  -d {{ .Values.postgresql.auth.database }} \
                  -c "UPDATE user_organization_memberships SET roles = '{organization_owner}', status = 'active', updated_at = NOW() WHERE user_id = '$USER_ID' AND organization_id = $ORG_ID;"
              else
                # Create membership
                MEMBERSHIP_ID=$(uuidgen | tr '[:upper:]' '[:lower:]')
                psql -h {{ .Values.postgresql.host | default (printf "%s-postgresql" .Release.Name) }} \
                  -U {{ .Values.postgresql.auth.username }} \
                  -d {{ .Values.postgresql.auth.database }} \
                  -c "INSERT INTO user_organization_memberships (id, user_id, organization_id, roles, invited_at, joined_at, status) \
                      VALUES ('$MEMBERSHIP_ID', '$USER_ID', $ORG_ID, '{organization_owner}', NOW(), NOW(), 'active');"
                echo "Created organization membership"
              fi
              
              # Show created user and membership
              echo "Platform admin user:"
              psql -h {{ .Values.postgresql.host | default (printf "%s-postgresql" .Release.Name) }} \
                -U {{ .Values.postgresql.auth.username }} \
                -d {{ .Values.postgresql.auth.database }} \
                -c "SELECT id, email, display_name, idp_provider FROM users WHERE email = 'admin@{{ .Values.keycloak.realmName }}.local';"
              {{- end }}
              
              echo "Setup complete!"
          env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.postgresql.auth.existingSecret | default (printf "%s-postgresql" .Release.Name) }}
                  key: {{ .Values.postgresql.auth.secretKeys.userPasswordKey | default "password" }}
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi
      # This job should run after the application starts and runs migrations
      initContainers:
        - name: wait-for-schema
          image: postgres:15-alpine
          command: ['sh', '-c']
          args:
            - |
              echo "Waiting for database schema to be ready..."
              
              # Wait for database to be reachable
              until pg_isready -h {{ .Values.postgresql.host | default (printf "%s-postgresql" .Release.Name) }} -p 5432 -U {{ .Values.postgresql.auth.username }}; do
                echo "Waiting for database to be ready..."
                sleep 5
              done
              
              # Wait for required tables to exist (migrations run on app startup)
              echo "Checking for required tables..."
              REQUIRED_TABLES="organization users user_organization_memberships"
              MAX_ATTEMPTS=30
              ATTEMPT=1
              
              while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
                ALL_EXIST=true
                for TABLE in $REQUIRED_TABLES; do
                  EXISTS=$(psql -h {{ .Values.postgresql.host | default (printf "%s-postgresql" .Release.Name) }} \
                    -U {{ .Values.postgresql.auth.username }} \
                    -d {{ .Values.postgresql.auth.database }} \
                    -t -c "SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_name = '$TABLE');" | tr -d ' ')
                  
                  if [ "$EXISTS" != "t" ]; then
                    ALL_EXIST=false
                    echo "Table $TABLE does not exist yet..."
                    break
                  fi
                done
                
                if [ "$ALL_EXIST" = "true" ]; then
                  echo "All required tables exist!"
                  exit 0
                fi
                
                echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Waiting 10 seconds for migrations..."
                sleep 10
                ATTEMPT=$((ATTEMPT + 1))
              done
              
              echo "Warning: Some tables may not exist, but proceeding..."
              exit 0
          env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.postgresql.auth.existingSecret | default (printf "%s-postgresql" .Release.Name) }}
                  key: {{ .Values.postgresql.auth.secretKeys.userPasswordKey | default "password" }}
{{- end }}
