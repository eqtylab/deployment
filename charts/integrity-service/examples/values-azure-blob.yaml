# Azure Blob Storage Configuration
# Production deployment using Azure Blob Storage with AKS
#
# Usage:
#   helm install integrity-service ./charts/integrity-service -f examples/values-azure-blob.yaml
#
# Prerequisites:
#   - Azure AKS cluster with Workload Identity (recommended)
#   - Azure Storage Account with Blob container
#   - Azure Database for PostgreSQL
#   - Azure Key Vault for credential signing
#   - nginx ingress or Azure Application Gateway
#
# This example demonstrates:
#   - Azure Blob Storage configuration
#   - AKS with Workload Identity (recommended over access keys)
#   - Azure PostgreSQL connection
#   - Azure Key Vault integration
#   - Production-ready settings

# =============================================================================
# DEPLOYMENT CONFIGURATION
# =============================================================================

replicaCount: 2

image:
  repository: ghcr.io/eqtylab/integrity-service
  pullPolicy: Always
  tag: ""

imagePullSecrets:
  - name: "acr-registry-credentials"

# AKS Service Account with Workload Identity
serviceAccount:
  create: true
  automount: true
  annotations:
    # Workload Identity annotation
    azure.workload.identity/client-id: "00000000-0000-0000-0000-000000000000"
  name: ""

resources:
  requests:
    cpu: 200m
    memory: 256Mi
  limits:
    cpu: 1000m
    memory: 1Gi

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# =============================================================================
# SERVICE CONFIGURATION
# =============================================================================

service:
  enabled: true
  type: ClusterIP
  port: 3050

# =============================================================================
# INGRESS CONFIGURATION
# =============================================================================

ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/proxy-body-size: "64m"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-Frame-Options "SAMEORIGIN" always;
  hosts:
    - host: governance.your-domain.com
      paths:
        - path: "/integrityService(/|$)(.*)"
          pathType: ImplementationSpecific
  tls:
    - secretName: integrity-service-tls
      hosts:
        - governance.your-domain.com

# Alternative: Azure Application Gateway Ingress
# ingress:
#   enabled: true
#   className: "azure-application-gateway"
#   annotations:
#     appgw.ingress.kubernetes.io/ssl-redirect: "true"
#     appgw.ingress.kubernetes.io/backend-path-prefix: "/"
#   hosts:
#     - host: governance.your-domain.com
#       paths:
#         - path: /integrityService
#           pathType: Prefix

# =============================================================================
# APPLICATION CONFIGURATION - AZURE BLOB
# =============================================================================

env:
  rustEnv: "production"

  # Azure Database for PostgreSQL connection
  integrityAppDbHost: "integrity-db.postgres.database.azure.com"
  integrityAppDbName: "IntegrityServiceDB"
  # User from secrets

  # Azure Blob Storage Configuration
  integrityAppBlobStoreType: "azure_blob"
  integrityAppBlobStoreContainer: "integrity-artifacts"
  # Account name and key from secrets (or use Managed Identity)

  # Production logging
  integrityAppLoggingLogLevelDefault: "warn"
  integrityAppLoggingLogLevelIntegrityService: "info"

  # Auth service URL
  integrityAppAuthType: "auth_service"
  integrityAppAuthUrl: "http://governance-platform-auth-service:8080"

  # Auth signer - Azure Key Vault
  integrityAppAuthSignerConfigType: "azure_key_vault"

  # Public service URL
  integrityServiceUrl: "https://governance.your-domain.com/integrityService"

# =============================================================================
# SECRET CONFIGURATION
# =============================================================================

secrets:
  # Azure PostgreSQL credentials
  database:
    enabled: true
    name: "platform-database"
    keys:
      username: "username"
      password: "password"

  # Azure Blob Storage credentials
  # With Workload Identity, you may only need accountName
  storage:
    azure_blob:
      enabled: true
      name: "platform-azure-storage"
      keys:
        accountName: "account-name"
        accountKey: "account-key"
        connectionString: "connection-string"

  # Azure Key Vault for signing operations
  secretManager:
    azure_key_vault:
      enabled: true
      name: "platform-azure-key-vault"
      keys:
        clientId: "client-id"
        clientSecret: "client-secret"
        tenantId: "tenant-id"
        vaultUrl: "vault-url"

# =============================================================================
# HIGH AVAILABILITY
# =============================================================================

podDisruptionBudget:
  minAvailable: 1

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - integrity-service
          topologyKey: topology.kubernetes.io/zone

nodeSelector: {}
tolerations: []

# =============================================================================
# SECURITY
# =============================================================================

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false # Rust app needs write access
  runAsNonRoot: true
  runAsUser: 1000

# =============================================================================
# PROBES
# =============================================================================

startupProbe:
  httpGet:
    path: /health/v1
    port: http
  failureThreshold: 30
  periodSeconds: 10

livenessProbe:
  httpGet:
    path: /health/v1
    port: http
  initialDelaySeconds: 10
  periodSeconds: 15
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /health/v1
    port: http
  initialDelaySeconds: 5
  periodSeconds: 5
  failureThreshold: 2

# =============================================================================
# WORKLOAD IDENTITY LABELS (AKS)
# =============================================================================

podLabels:
  storage-provider: "azure-blob"
  cloud-provider: "azure"
  azure.workload.identity/use: "true"
