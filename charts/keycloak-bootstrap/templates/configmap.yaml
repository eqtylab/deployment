{{- if .Values.bootstrap.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "keycloak-bootstrap.fullname" . }}-scripts
  labels:
    {{- include "keycloak-bootstrap.labels" . | nindent 4 }}
data:
  bootstrap.sh: |
    #!/bin/sh
    set -e

    # Colors for output
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m' # No Color

    # Configuration from environment
    KEYCLOAK_URL="${KEYCLOAK_URL}"
    KEYCLOAK_ADMIN="${KEYCLOAK_ADMIN_USERNAME}"
    KEYCLOAK_ADMIN_PASSWORD="${KEYCLOAK_ADMIN_PASSWORD}"
    REALM_NAME="{{ .Values.keycloak.realm.name }}"

    echo "Starting Keycloak bootstrap process..."
    echo "Keycloak URL: ${KEYCLOAK_URL}"
    echo "Realm: ${REALM_NAME}"

    # Function to get admin token
    get_admin_token() {
      echo "Getting admin token..."
      TOKEN=$(curl -s -X POST "${KEYCLOAK_URL}/realms/master/protocol/openid-connect/token" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        --data-urlencode "username=${KEYCLOAK_ADMIN}" \
        --data-urlencode "password=${KEYCLOAK_ADMIN_PASSWORD}" \
        -d "grant_type=password" \
        -d "client_id=admin-cli" | jq -r '.access_token')

      if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
        echo "Failed to get admin token"
        return 1
      fi
      echo "Successfully obtained admin token"
      return 0
    }

    # Function to check if realm exists
    check_realm_exists() {
      echo "Checking if realm ${REALM_NAME} exists..."
      RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
        -H "Authorization: Bearer ${TOKEN}" \
        "${KEYCLOAK_URL}/admin/realms/${REALM_NAME}")

      if [ "$RESPONSE" = "200" ]; then
        echo "Realm ${REALM_NAME} already exists"
        return 0
      else
        echo "Realm ${REALM_NAME} does not exist"
        return 1
      fi
    }

    # Function to create realm
    create_realm() {
      echo "Creating realm ${REALM_NAME}..."
      REALM_CONFIG=$(cat <<EOF
    {
      "realm": "${REALM_NAME}",
      "displayName": {{ .Values.keycloak.realm.displayName | toJson }},
      "displayNameHtml": {{ .Values.keycloak.realm.displayNameHtml | toJson }},
      "enabled": true,
      "registrationAllowed": {{ .Values.keycloak.realm.registrationAllowed }},
      "loginWithEmailAllowed": {{ .Values.keycloak.realm.loginWithEmailAllowed }},
      "duplicateEmailsAllowed": false,
      "resetPasswordAllowed": {{ .Values.keycloak.realm.resetPasswordAllowed }},
      "rememberMe": {{ .Values.keycloak.realm.rememberMe }},
      "verifyEmail": {{ .Values.keycloak.realm.verifyEmail }},
      "sslRequired": "{{ .Values.keycloak.realm.sslRequired }}",
      "bruteForceProtected": {{ .Values.keycloak.realm.bruteForceProtected }},
      "accessTokenLifespan": {{ .Values.keycloak.tokens.accessTokenLifespan }},
      "ssoSessionIdleTimeout": {{ .Values.keycloak.tokens.ssoSessionIdleTimeout }},
      "ssoSessionMaxLifespan": {{ .Values.keycloak.tokens.ssoSessionMaxLifespan }},
      "internationalizationEnabled": false,
      "defaultSignatureAlgorithm": "RS256"
    }
    EOF
    )

      RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${KEYCLOAK_URL}/admin/realms" \
        -H "Authorization: Bearer ${TOKEN}" \
        -H "Content-Type: application/json" \
        -d "${REALM_CONFIG}")

      if [ "$RESPONSE" = "201" ]; then
        echo "Realm created successfully"
        return 0
      else
        echo "Failed to create realm. Response code: $RESPONSE"
        return 1
      fi
    }

    # Function to create client scope
    create_client_scope() {
      local SCOPE_NAME=$1
      local SCOPE_DESC=$2

      echo "Creating client scope: ${SCOPE_NAME}..."
      SCOPE_CONFIG=$(cat <<EOF
    {
      "name": "${SCOPE_NAME}",
      "description": "${SCOPE_DESC}",
      "protocol": "openid-connect",
      "attributes": {
        "include.in.token.scope": "true",
        "display.on.consent.screen": "true"
      }
    }
    EOF
    )

      RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
        "${KEYCLOAK_URL}/admin/realms/${REALM_NAME}/client-scopes" \
        -H "Authorization: Bearer ${TOKEN}" \
        -H "Content-Type: application/json" \
        -d "${SCOPE_CONFIG}")

      if [ "$RESPONSE" = "201" ]; then
        echo "  Created scope: ${SCOPE_NAME}"
      elif [ "$RESPONSE" = "409" ]; then
        echo "  Scope already exists: ${SCOPE_NAME}"
      else
        echo "  Failed to create scope: ${SCOPE_NAME} (Response: $RESPONSE)"
      fi
    }

    # Function to get a client scope ID by name
    get_client_scope_id() {
      local SCOPE_NAME=$1
      curl -s \
        -H "Authorization: Bearer ${TOKEN}" \
        "${KEYCLOAK_URL}/admin/realms/${REALM_NAME}/client-scopes" | jq -r --arg name "$SCOPE_NAME" '.[] | select(.name == $name) | .id'
    }

    # Function to add a protocol mapper to a client scope
    add_protocol_mapper_to_scope() {
      local SCOPE_NAME=$1
      local MAPPER_NAME=$2
      local MAPPER_TYPE=$3
      local MAPPER_CONFIG=$4

      SCOPE_ID=$(get_client_scope_id "$SCOPE_NAME")
      if [ -z "$SCOPE_ID" ] || [ "$SCOPE_ID" = "null" ]; then
        echo "  Scope ${SCOPE_NAME} not found, skipping mapper"
        return 1
      fi

      echo "  Adding mapper '${MAPPER_NAME}' to scope '${SCOPE_NAME}'..."
      MAPPER_JSON=$(cat <<EOF
    {
      "name": "${MAPPER_NAME}",
      "protocol": "openid-connect",
      "protocolMapper": "${MAPPER_TYPE}",
      "config": ${MAPPER_CONFIG}
    }
    EOF
    )

      RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
        "${KEYCLOAK_URL}/admin/realms/${REALM_NAME}/client-scopes/${SCOPE_ID}/protocol-mappers/models" \
        -H "Authorization: Bearer ${TOKEN}" \
        -H "Content-Type: application/json" \
        -d "${MAPPER_JSON}")

      if [ "$RESPONSE" = "201" ]; then
        echo "  Mapper '${MAPPER_NAME}' added successfully"
      elif [ "$RESPONSE" = "409" ]; then
        echo "  Mapper '${MAPPER_NAME}' already exists"
      else
        echo "  Failed to add mapper '${MAPPER_NAME}' (Response: $RESPONSE)"
      fi
    }

    # Function to set a scope as a realm-level default scope
    # This sets the "Assigned type" to "Default" so it's added to all new clients
    set_realm_default_scope() {
      local SCOPE_NAME=$1

      SCOPE_ID=$(get_client_scope_id "$SCOPE_NAME")
      if [ -z "$SCOPE_ID" ] || [ "$SCOPE_ID" = "null" ]; then
        echo "  Scope ${SCOPE_NAME} not found"
        return 1
      fi

      echo "  Setting scope '${SCOPE_NAME}' as realm default..."
      RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X PUT \
        "${KEYCLOAK_URL}/admin/realms/${REALM_NAME}/default-default-client-scopes/${SCOPE_ID}" \
        -H "Authorization: Bearer ${TOKEN}")

      if [ "$RESPONSE" = "204" ]; then
        echo "  Scope '${SCOPE_NAME}' set as realm default"
      else
        echo "  Failed to set realm default scope (Response: $RESPONSE)"
      fi
    }

    # Function to assign a default scope to a specific client
    assign_default_scope_to_client() {
      local CLIENT_ID=$1
      local SCOPE_NAME=$2

      echo "  Assigning scope '${SCOPE_NAME}' to client '${CLIENT_ID}'..."

      # Get client internal UUID
      CLIENT_UUID=$(curl -s \
        -H "Authorization: Bearer ${TOKEN}" \
        "${KEYCLOAK_URL}/admin/realms/${REALM_NAME}/clients?clientId=${CLIENT_ID}" | jq -r '.[0].id')

      if [ -z "$CLIENT_UUID" ] || [ "$CLIENT_UUID" = "null" ]; then
        echo "  Client ${CLIENT_ID} not found"
        return 1
      fi

      SCOPE_ID=$(get_client_scope_id "$SCOPE_NAME")
      if [ -z "$SCOPE_ID" ] || [ "$SCOPE_ID" = "null" ]; then
        echo "  Scope ${SCOPE_NAME} not found"
        return 1
      fi

      RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X PUT \
        "${KEYCLOAK_URL}/admin/realms/${REALM_NAME}/clients/${CLIENT_UUID}/default-client-scopes/${SCOPE_ID}" \
        -H "Authorization: Bearer ${TOKEN}")

      if [ "$RESPONSE" = "204" ]; then
        echo "  Scope '${SCOPE_NAME}' assigned to '${CLIENT_ID}'"
      else
        echo "  Failed to assign scope (Response: $RESPONSE)"
      fi
    }

    # Function to create client
    create_client() {
      local CLIENT_ID=$1
      local CLIENT_NAME=$2
      local CLIENT_DESC=$3
      local PUBLIC_CLIENT=$4
      local SERVICE_ACCOUNT=$5
      local CLIENT_SECRET=$6
      local REDIRECT_URIS=$7
      local WEB_ORIGINS=$8

      echo "Creating client: ${CLIENT_ID}..."

      # Build redirect URIs array
      REDIRECT_URIS_JSON="[]"
      if [ -n "$REDIRECT_URIS" ]; then
        REDIRECT_URIS_JSON=$(echo "$REDIRECT_URIS" | jq -R -s -c 'split(",") | map(gsub("^\\s+|\\s+$";""))')
      fi

      # Build web origins array
      WEB_ORIGINS_JSON="[]"
      if [ -n "$WEB_ORIGINS" ]; then
        WEB_ORIGINS_JSON=$(echo "$WEB_ORIGINS" | jq -R -s -c 'split(",") | map(gsub("^\\s+|\\s+$";""))')
      fi

      CLIENT_CONFIG=$(cat <<EOF
    {
      "clientId": "${CLIENT_ID}",
      "name": "${CLIENT_NAME}",
      "description": "${CLIENT_DESC}",
      "enabled": true,
      "publicClient": ${PUBLIC_CLIENT},
      "serviceAccountsEnabled": ${SERVICE_ACCOUNT},
      "standardFlowEnabled": true,
      "implicitFlowEnabled": false,
      "directAccessGrantsEnabled": true,
      "protocol": "openid-connect",
      "redirectUris": ${REDIRECT_URIS_JSON},
      "webOrigins": ${WEB_ORIGINS_JSON},
      "defaultClientScopes": ["openid", "profile", "email", "roles"],
      "optionalClientScopes": ["offline_access"]
    }
    EOF
    )

      # Add secret if not public client
      if [ "$PUBLIC_CLIENT" = "false" ] && [ -n "$CLIENT_SECRET" ]; then
        CLIENT_CONFIG=$(echo "$CLIENT_CONFIG" | jq --arg secret "$CLIENT_SECRET" '. + {secret: $secret}')
      fi

      RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
        "${KEYCLOAK_URL}/admin/realms/${REALM_NAME}/clients" \
        -H "Authorization: Bearer ${TOKEN}" \
        -H "Content-Type: application/json" \
        -d "${CLIENT_CONFIG}")

      if [ "$RESPONSE" = "201" ]; then
        echo "  Client created successfully"
        return 0
      elif [ "$RESPONSE" = "409" ]; then
        echo "  Client already exists"
        return 0
      else
        echo "  Failed to create client. Response code: $RESPONSE"
        return 1
      fi
    }

    # Function to assign service account roles
    assign_service_account_roles() {
      local CLIENT_ID=$1
      local TARGET_CLIENT_ID=$2
      local ROLES=$3

      echo "Assigning service account roles for ${CLIENT_ID}..."

      # Get the client's internal ID
      CLIENT_UUID=$(curl -s \
        -H "Authorization: Bearer ${TOKEN}" \
        "${KEYCLOAK_URL}/admin/realms/${REALM_NAME}/clients?clientId=${CLIENT_ID}" | jq -r '.[0].id')

      if [ "$CLIENT_UUID" = "null" ] || [ -z "$CLIENT_UUID" ]; then
        echo "  Failed to get client UUID for ${CLIENT_ID}"
        return 1
      fi

      # Get the service account user ID
      SERVICE_ACCOUNT_USER=$(curl -s \
        -H "Authorization: Bearer ${TOKEN}" \
        "${KEYCLOAK_URL}/admin/realms/${REALM_NAME}/clients/${CLIENT_UUID}/service-account-user")

      SERVICE_ACCOUNT_USER_ID=$(echo "$SERVICE_ACCOUNT_USER" | jq -r '.id')

      if [ "$SERVICE_ACCOUNT_USER_ID" = "null" ] || [ -z "$SERVICE_ACCOUNT_USER_ID" ]; then
        echo "  Failed to get service account user for ${CLIENT_ID}"
        return 1
      fi

      # Get the target client's internal ID (e.g., realm-management)
      TARGET_CLIENT_UUID=$(curl -s \
        -H "Authorization: Bearer ${TOKEN}" \
        "${KEYCLOAK_URL}/admin/realms/${REALM_NAME}/clients?clientId=${TARGET_CLIENT_ID}" | jq -r '.[0].id')

      if [ "$TARGET_CLIENT_UUID" = "null" ] || [ -z "$TARGET_CLIENT_UUID" ]; then
        echo "  Failed to get client UUID for ${TARGET_CLIENT_ID}"
        return 1
      fi

      # Get available roles from the target client
      AVAILABLE_ROLES=$(curl -s \
        -H "Authorization: Bearer ${TOKEN}" \
        "${KEYCLOAK_URL}/admin/realms/${REALM_NAME}/clients/${TARGET_CLIENT_UUID}/roles")

      # Build the roles array to assign
      ROLES_TO_ASSIGN="["
      FIRST=true
      for ROLE_NAME in $(echo "$ROLES" | tr ',' ' '); do
        ROLE_ID=$(echo "$AVAILABLE_ROLES" | jq -r --arg name "$ROLE_NAME" '.[] | select(.name == $name) | .id')
        ROLE_OBJ=$(echo "$AVAILABLE_ROLES" | jq -c --arg name "$ROLE_NAME" '.[] | select(.name == $name)')

        if [ -n "$ROLE_OBJ" ] && [ "$ROLE_OBJ" != "null" ]; then
          if [ "$FIRST" = "true" ]; then
            FIRST=false
          else
            ROLES_TO_ASSIGN="${ROLES_TO_ASSIGN},"
          fi
          ROLES_TO_ASSIGN="${ROLES_TO_ASSIGN}${ROLE_OBJ}"
          echo "  Found role: ${ROLE_NAME}"
        else
          echo "  Warning: Role ${ROLE_NAME} not found in ${TARGET_CLIENT_ID}"
        fi
      done
      ROLES_TO_ASSIGN="${ROLES_TO_ASSIGN}]"

      # Assign the roles to the service account
      RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
        "${KEYCLOAK_URL}/admin/realms/${REALM_NAME}/users/${SERVICE_ACCOUNT_USER_ID}/role-mappings/clients/${TARGET_CLIENT_UUID}" \
        -H "Authorization: Bearer ${TOKEN}" \
        -H "Content-Type: application/json" \
        -d "${ROLES_TO_ASSIGN}")

      if [ "$RESPONSE" = "204" ]; then
        echo "  Service account roles assigned successfully"
        return 0
      else
        echo "  Failed to assign roles. Response code: $RESPONSE"
        return 1
      fi
    }

    # Function to create user
    create_user() {
      local USERNAME=$1
      local EMAIL=$2
      local FIRST_NAME=$3
      local LAST_NAME=$4
      local PASSWORD=$5
      local TEMP_PASSWORD=$6

      echo "Creating user: ${USERNAME}..."

      USER_CONFIG=$(cat <<EOF
    {
      "username": "${USERNAME}",
      "email": "${EMAIL}",
      "emailVerified": true,
      "enabled": true,
      "firstName": "${FIRST_NAME}",
      "lastName": "${LAST_NAME}",
      "credentials": [{
        "type": "password",
        "value": "${PASSWORD}",
        "temporary": ${TEMP_PASSWORD}
      }]
    }
    EOF
    )

      RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
        "${KEYCLOAK_URL}/admin/realms/${REALM_NAME}/users" \
        -H "Authorization: Bearer ${TOKEN}" \
        -H "Content-Type: application/json" \
        -d "${USER_CONFIG}")

      if [ "$RESPONSE" = "201" ]; then
        echo "  User created successfully"
        return 0
      elif [ "$RESPONSE" = "409" ]; then
        echo "  User already exists"
        return 0
      else
        echo "  Failed to create user. Response code: $RESPONSE"
        return 1
      fi
    }

    # Main bootstrap process
    main() {
      # Get admin token
      if ! get_admin_token; then
        echo "Failed to authenticate with Keycloak"
        exit 1
      fi

      # Create or update realm
      if ! check_realm_exists; then
        if ! create_realm; then
          echo "Failed to create realm"
          exit 1
        fi
      fi

      # Create client scopes
      {{- range .Values.scopes }}
      create_client_scope "{{ .name }}" "{{ .description }}"
      {{- end }}

      # Create frontend client
      {{- with .Values.clients.frontend }}
      create_client \
        "{{ .clientId }}" \
        "{{ .name }}" \
        "{{ .description }}" \
        "{{ .publicClient }}" \
        "false" \
        "" \
        "{{ join "," .redirectUris }}" \
        "{{ join "," .webOrigins }}"

      # Create custom scopes with mappers and assign to frontend client
      {{- range .customScopes }}
      {{- $scopeName := .name }}
      create_client_scope "{{ .name }}" "{{ .description }}"
      {{- range .mappers }}
      add_protocol_mapper_to_scope "{{ $scopeName }}" "{{ .name }}" "{{ .protocolMapper }}" '{{ .config | toJson }}'
      {{- end }}
      set_realm_default_scope "{{ .name }}"
      assign_default_scope_to_client "{{ $.Values.clients.frontend.clientId }}" "{{ .name }}"
      {{- end }}
      {{- end }}

      # Create backend client (secret auto-generated by Keycloak)
      {{- with .Values.clients.backend }}
      create_client \
        "{{ .clientId }}" \
        "{{ .name }}" \
        "{{ .description }}" \
        "{{ .publicClient }}" \
        "{{ .serviceAccountsEnabled }}" \
        "" \
        "{{ join "," .redirectUris }}" \
        "{{ join "," .webOrigins }}"

      # Assign service account roles for backend client
      {{- if and .serviceAccountsEnabled .serviceAccountRoles }}
      {{- range .serviceAccountRoles }}
      assign_service_account_roles \
        "{{ $.Values.clients.backend.clientId }}" \
        "{{ .clientId }}" \
        "{{ join "," .roles }}"
      {{- end }}
      {{- end }}
      {{- end }}

      # Create worker client (secret auto-generated by Keycloak)
      {{- with .Values.clients.worker }}
      create_client \
        "{{ .clientId }}" \
        "{{ .name }}" \
        "{{ .description }}" \
        "{{ .publicClient }}" \
        "{{ .serviceAccountsEnabled }}" \
        "" \
        "" \
        ""
      {{- end }}

      # Create admin user
      {{- if .Values.users.admin.enabled }}
      ADMIN_PASSWORD="${ADMIN_USER_PASSWORD}"
      create_user \
        "{{ .Values.users.admin.username }}" \
        "{{ .Values.users.admin.email }}" \
        "{{ .Values.users.admin.firstName }}" \
        "{{ .Values.users.admin.lastName }}" \
        "${ADMIN_PASSWORD}" \
        "{{ not .Values.users.admin.temporaryPassword }}"
      {{- end }}

      # Create test users
      {{- if .Values.users.testUsers.enabled }}
      {{- range .Values.users.testUsers.users }}
      create_user \
        "{{ .username }}" \
        "{{ .email }}" \
        "{{ .firstName }}" \
        "{{ .lastName }}" \
        "{{ .password }}" \
        "false"
      {{- end }}
      {{- end }}

      echo "Keycloak bootstrap completed successfully!"

    }

    # Run main function
    main
{{- end }}
