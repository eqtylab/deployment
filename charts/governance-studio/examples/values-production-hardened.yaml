# Production Hardened Configuration
# Maximum security configuration for production environments
#
# Usage:
#   helm install governance-studio ./charts/governance-studio -f examples/values-production-hardened.yaml
#
# This example demonstrates:
#   - Strict security contexts and pod security
#   - Resource limits and quotas
#   - High availability with anti-affinity
#   - Read-only file systems
#   - Non-root execution
#   - Rate limiting and security headers
#   - Comprehensive health probes

# =============================================================================
# DEPLOYMENT CONFIGURATION
# =============================================================================

replicaCount: 5

image:
  repository: ghcr.io/eqtylab/governance-studio
  pullPolicy: Always
  tag: "1.0.0" # Pin to specific version

imagePullSecrets:
  - name: "prod-registry-credentials"

serviceAccount:
  create: true
  automount: false # Disable auto-mount for security
  annotations:
    # AWS EKS IRSA
    eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/governance-studio-prod"
    # Or GKE Workload Identity
    # iam.gke.io/gcp-service-account: "governance-studio@your-project.iam.gserviceaccount.com"
  name: "governance-studio-prod"

# =============================================================================
# SECURITY CONTEXTS (HARDENED)
# =============================================================================

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 65534
  runAsGroup: 65534
  fsGroup: 65534
  fsGroupChangePolicy: "OnRootMismatch"
  seccompProfile:
    type: RuntimeDefault

securityContext:
  allowPrivilegeEscalation: false
  privileged: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 65534
  runAsGroup: 65534
  seccompProfile:
    type: RuntimeDefault

# =============================================================================
# RESOURCE CONFIGURATION (HARDENED)
# =============================================================================

resources:
  requests:
    cpu: 200m
    memory: 256Mi
    ephemeral-storage: "50Mi"
  limits:
    cpu: 1000m
    memory: 1Gi
    ephemeral-storage: "200Mi"

autoscaling:
  enabled: true
  minReplicas: 5
  maxReplicas: 20
  targetCPUUtilizationPercentage: 60
  targetMemoryUtilizationPercentage: 70

# =============================================================================
# SERVICE CONFIGURATION
# =============================================================================

service:
  enabled: true
  type: ClusterIP
  port: 80

# =============================================================================
# INGRESS CONFIGURATION (HARDENED)
# =============================================================================

ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    # Strict security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-Frame-Options "DENY" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;
      add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://*.auth0.com https://*.googleapis.com; frame-ancestors 'none';" always;
      add_header Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()" always;
    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "30"
    nginx.ingress.kubernetes.io/limit-connections: "20"
    nginx.ingress.kubernetes.io/limit-rpm: "300"
    # Timeouts
    nginx.ingress.kubernetes.io/proxy-body-size: "32m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "10"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "30"
    # HSTS
    nginx.ingress.kubernetes.io/server-snippet: |
      add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
  hosts:
    - host: governance.production-domain.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: governance-studio-prod-tls
      hosts:
        - governance.production-domain.com

# =============================================================================
# APPLICATION CONFIGURATION
# =============================================================================

config:
  basePath: /

  # Production backend URLs
  apiUrl: "https://governance.production-domain.com/governanceService"
  authServiceUrl: "https://governance.production-domain.com/authService"
  integrityServiceUrl: "https://governance.production-domain.com/integrityService"

  # Auth0 production tenant
  authProvider: "auth0"
  auth0Domain: "prod-your-tenant.us.auth0.com"
  auth0ClientId: "YOUR_PROD_AUTH0_SPA_CLIENT_ID"
  auth0Audience: "https://prod-your-tenant.us.auth0.com/api/v2/"

  # Environment settings
  environment: "production"
  appTitle: "Governance Studio"

  # Core features only for production
  features:
    governance: true
    lineage: true
    guardianEnabled: false
    guardianGarage: false
    guardianRulebooks: false
    guardianOsFunctions: false
    guardianSdkFunctions: false
    agentManagement: false

# =============================================================================
# HIGH AVAILABILITY (HARDENED)
# =============================================================================

podDisruptionBudget:
  minAvailable: 3

affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
                - governance-studio
        topologyKey: "kubernetes.io/hostname"
      - labelSelector:
          matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
                - governance-studio
        topologyKey: "topology.kubernetes.io/zone"

nodeSelector:
  node-type: "production"

tolerations:
  - key: "production"
    operator: "Equal"
    value: "true"
    effect: "NoSchedule"

# =============================================================================
# PROBES (CONSERVATIVE)
# =============================================================================

startupProbe:
  httpGet:
    path: /
    port: http
  failureThreshold: 60
  periodSeconds: 5

livenessProbe:
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 60
  periodSeconds: 15
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# =============================================================================
# POD LABELS AND ANNOTATIONS
# =============================================================================

podLabels:
  security.kubernetes.io/audit: "true"
  environment: "production"

podAnnotations:
  seccomp.security.alpha.kubernetes.io/pod: runtime/default
  container.apparmor.security.beta.kubernetes.io/governance-studio: runtime/default
